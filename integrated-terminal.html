<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Integrated Hydraulic Test Pro | NIK Terminal</title>
    
    <script>
        if (localStorage.getItem('isLoggedIn') !== 'true') { window.location.replace('login.html'); }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=JetBrains+Mono:wght@700&display=swap');
        
        :root { --base-width: 720px; }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: #f1f5f9; 
            min-height: 100vh; 
            margin: 0; 
            padding: 0; 
            overflow-x: hidden; 
            display: flex; 
            justify-content: center; 
            align-items: flex-start; 
        }

        #scaler-context { 
            width: var(--base-width); 
            transform-origin: top center; 
            transition: transform 0.2s ease-out; 
            flex-shrink: 0; 
            padding: 1.5rem; 
            position: relative; 
            z-index: 10;
        }

        /* Glacial Card Style */
        .glass-card { background: white; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border-radius: 1.5rem; overflow: hidden; margin-bottom: 1rem; }
        .header-label { font-size: 8px; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 4px; display: block; }
        .input-glacial { width: 100%; padding: 10px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 0.75rem; font-size: 12px; font-weight: 700; outline: none; color: #1e3a8a; transition: 0.2s; }
        .input-glacial:focus { border-color: #3b82f6; background: white; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .input-readonly { background: #f1f5f9 !important; color: #94a3b8 !important; cursor: not-allowed; border-style: dashed; }
        
        /* Side Drawer NIK Riwayat */
        #history-panel { 
            position: fixed; top: 0; right: 0; height: 100vh; width: 320px; z-index: 1000; 
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); border-left: 2px solid #3b82f6;
            background: white; box-shadow: -10px 0 25px -5px rgba(0, 0, 0, 0.08); display: flex; flex-direction: column;
        }
        #history-panel.minimized { transform: translateX(320px); }

        #history-trigger {
            position: fixed; right: 0; top: 50%; transform: translateY(-50%);
            background: #3b82f6; color: white; padding: 15px 6px; border-radius: 12px 0 0 12px;
            cursor: pointer; z-index: 999; writing-mode: vertical-rl; text-orientation: mixed;
            font-size: 8px; font-weight: 900; letter-spacing: 2px; box-shadow: -2px 0 10px rgba(59, 130, 246, 0.3); transition: 0.3s;
        }

        .table-custom { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc !important; color: #64748b !important; font-size: 7px; text-transform: uppercase; padding: 8px 2px !important; font-weight: 800; border-bottom: 2px solid #e2e8f0; text-align: center; }
        td { border-bottom: 1px solid #f1f5f9; padding: 8px 4px; font-size: 10px; text-align: center; font-weight: 600; }
        
        .std-text { color: #f87171; font-weight: 800; font-size: 9px; }
        .qc-output { font-size: 11px; font-weight: 900; font-family: 'JetBrains Mono', monospace; }
        .chart-container { height: 320px; width: 100%; padding: 15px; }
        
        #loadingOverlay { position: fixed; inset: 0; background: rgba(30, 58, 138, 0.9); z-index: 1100; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .tab-btn.active { border-bottom: 3px solid #3b82f6; color: #3b82f6; }
        .status-badge-new { background: #dcfce7; color: #166534; }
        .status-badge-edit { background: #fef9c3; color: #854d0e; }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div class="w-10 h-10 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 font-black text-white text-[10px] tracking-widest uppercase italic">NIK Cloud Sync Active...</p>
    </div>

    <div id="history-panel" class="minimized">
        <div class="history-header p-4 border-b flex justify-between items-center bg-slate-50">
            <h3 class="text-[10px] font-black text-slate-800 uppercase tracking-tight"><i class="fas fa-database text-blue-600 mr-2"></i>NIK RIWAYAT</h3>
            <button onclick="toggleHistory()" class="text-slate-400 hover:text-red-500 transition-colors"><i class="fas fa-times"></i></button>
        </div>
        <div class="history-content flex-1 overflow-y-auto p-3">
            <div id="history-list" class="space-y-1"></div>
        </div>
    </div>

    <div id="history-trigger" onclick="toggleHistory(event)"><i class="fas fa-history mb-2"></i> RIWAYAT DATA</div>

    <div id="scaler-context">
        <header class="glass-card p-5 flex justify-between items-center no-print border-l-8 border-blue-600">
            <div>
                <h1 class="text-sm font-black italic text-slate-900 uppercase tracking-tighter leading-none">Hydraulic <span class="text-blue-600">Tune-Up</span></h1>
                <div id="accessBadge" class="status-badge-new inline-block mt-2 px-2 py-0.5 rounded text-[7px] font-black uppercase tracking-tighter">
                    <i class="fas fa-circle mr-1"></i> <span id="sync-status">New Entry Mode</span>
                </div>
            </div>
            <div class="flex gap-2 items-center">
                <button onclick="switchTab('general')" id="tab-gen" class="tab-btn active px-3 py-1 text-[9px] font-black uppercase">General Test</button>
                <button onclick="switchTab('pump')" id="tab-pump" class="tab-btn px-3 py-1 text-[9px] font-black uppercase">Pump Analysis</button>
                <button onclick="prepareNewEntry()" class="bg-slate-100 text-slate-600 px-3 py-2 rounded-xl font-black text-[9px] uppercase hover:bg-slate-200 transition-all">New</button>
                <button type="button" onclick="saveToCloud()" class="bg-blue-600 text-white px-5 py-2 rounded-xl font-black text-[9px] uppercase shadow-lg shadow-blue-200">Sync Data</button>
            </div>
        </header>

        <div class="glass-card p-6">
            <input type="hidden" id="current_record_id">
            <div class="grid grid-cols-4 gap-4">
                <div class="col-span-1"><label class="header-label text-blue-600">Date</label><input type="date" id="test_date" class="input-glacial !p-2"></div>
                <div class="col-span-1"><label class="header-label">Unit Model</label><input type="text" id="unit_model" class="input-glacial !p-2 uppercase" placeholder="EX3600-6"></div>
                <div class="col-span-1"><label class="header-label">Serial No</label><input type="text" id="serial_num" class="input-glacial !p-2 uppercase" placeholder="SN12345"></div>
                <div class="col-span-1"><label class="header-label">NIK (Settings)</label><div id="display-nik" class="text-[11px] font-black text-blue-600 mt-2 font-mono">LOADING...</div><input type="hidden" id="nik"></div>
                <div class="col-span-2"><label class="header-label">Technician Name</label><input type="text" id="nama_pic" class="input-glacial input-readonly" readonly></div>
                <div class="col-span-2"><label class="header-label">Hour Meter (HM)</label><input type="number" id="hour_meter" class="input-glacial" placeholder="0.0"></div>
            </div>
        </div>

        <div id="section-general" class="space-y-4">
            <div class="glass-card">
                <div class="bg-slate-50 p-2 border-b border-slate-100"><h3 class="text-[9px] font-black text-slate-500 uppercase px-2"><i class="fas fa-history mr-2"></i>1. Component & Oil History</h3></div>
                <table class="w-full">
                    <thead><tr><th class="text-left pl-4">Component</th><th>Serial</th><th>Part No</th><th>Lifetime</th><th>Model</th></tr></thead>
                    <tbody id="comp-history-body"></tbody>
                </table>
            </div>
            <div class="glass-card">
                <div class="bg-slate-50 p-2 border-b border-slate-100"><h3 class="text-[9px] font-black text-slate-500 uppercase px-2"><i class="fas fa-gauge-high mr-2"></i>2. Main Relief Pressure (Kgf/cm²)</h3></div>
                <div class="p-5 grid grid-cols-4 gap-4" id="pump-relief-grid"></div>
                <div class="bg-blue-50 py-2 text-center border-t border-blue-100"><span class="text-[9px] font-black text-blue-400 tracking-widest uppercase italic">STANDARD: 300 - 320 Kgf/cm²</span></div>
            </div>
            <div class="glass-card">
                <div class="bg-slate-50 p-2 border-b border-slate-100"><h3 class="text-[9px] font-black text-slate-500 uppercase px-2"><i class="fas fa-bolt mr-2"></i>3. Engine Speed (RPM)</h3></div>
                <table class="w-full"><thead><tr><th class="text-left pl-4">Condition</th><th>Standard</th><th class="text-blue-600">Before</th><th class="text-green-600">After</th></tr></thead><tbody id="engine-speed-body"></tbody></table>
            </div>
            <div class="glass-card">
                <div class="bg-slate-50 p-2 border-b border-slate-100"><h3 class="text-[9px] font-black text-slate-500 uppercase px-2"><i class="fas fa-stopwatch mr-2"></i>4. Cycle Time (Sec)</h3></div>
                <table class="w-full text-center"><thead><tr><th class="text-left pl-4">Action</th><th>Std</th><th class="text-blue-600">Before</th><th class="text-green-600">After</th></tr></thead><tbody id="cycle-time-body"></tbody></table>
            </div>
        </div>

        <div id="section-pump" class="hidden space-y-4">
            <div class="flex justify-between items-center bg-slate-800 text-white p-3 rounded-xl mb-2">
                <span class="text-[10px] font-black uppercase">Active Analysis: Pump <span id="active-p-num">1</span></span>
                <select id="pump-select" onchange="changePump(this.value)" class="bg-slate-700 text-[10px] font-bold border-none rounded px-2 py-1 outline-none">
                    <option value="1">PUMP 1</option><option value="2">PUMP 2</option><option value="3">PUMP 3</option><option value="4">PUMP 4</option>
                    <option value="5">PUMP 5</option><option value="6">PUMP 6</option><option value="7">PUMP 7</option><option value="8">PUMP 8</option>
                </select>
            </div>
            <div id="pump-tables-container"></div>
            <div class="glass-card bg-white chart-container"><canvas id="nikChart"></canvas></div>
            <textarea id="nik-notes" class="w-full glass-card p-3 text-[11px] font-semibold h-20 focus:outline-none" placeholder="Technical analysis notes..."></textarea>
        </div>

        <footer class="text-center py-6">
            <p class="text-slate-300 text-[8px] uppercase font-black tracking-[0.4em] italic">© 2026 PT HEXINDO ADARO | NIK SECURED TERMINAL</p>
        </footer>
    </div>

    <script>
        const sb = supabase.createClient('https://corpgiuxyhfxdnqwwmlv.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNvcnBnaXV4eWhmeGRucXd3bWx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDMwNzcsImV4cCI6MjA4NTg3OTA3N30.PMp5yZOISYrBG0UUcIGaXUPnmEAaWVKgQ3Y1W8Nea_E');
        
        let currentPump = "1";
        let nikChart;
        let masterStore = JSON.parse(localStorage.getItem('nik_master_store')) || {};

        const pumpFlowStd = [
            { label: 'P50', p: '50 ± 2', ne: 1900, i: 1.02, np: 1838, min: 524, max: 535, std: '502 ± 5' },
            { label: 'P137', p: '137 ± 5', ne: 1900, i: 1.02, np: 1838, min: 512, max: 523, std: '491 ± 5' },
            { label: 'P170', p: '170', ne: 1900, i: 1.02, np: 1838, min: 422, max: 453, std: '415 ± 15' },
            { label: 'P250', p: '250 ± 5', ne: 1900, i: 1.02, np: 1838, min: 284, max: 315, std: '284 ± 15' },
            { label: 'P300', p: '300 ± 2', ne: 1900, i: 1.02, np: 1838, min: 234, max: 245, std: '227 ± 5' }
        ];

        function runAutoScale() {
            const scaler = document.getElementById('scaler-context');
            const windowWidth = window.innerWidth;
            const scaleRatio = Math.min(windowWidth / 720, 1);
            if (windowWidth < 720) {
                scaler.style.transform = `scale(${scaleRatio})`;
                scaler.style.marginBottom = `-${(1 - scaleRatio) * scaler.offsetHeight}px`;
            } else {
                scaler.style.transform = `scale(1)`;
                scaler.style.marginBottom = `0px`;
            }
        }

        function handleKeyNavigation(e) {
            if (e.key === "Enter") {
                e.preventDefault();
                const focusable = Array.from(document.querySelectorAll('input:not([readonly]), textarea, select'));
                const index = focusable.indexOf(e.target);
                if (index > -1 && index < focusable.length - 1) focusable[index + 1].focus();
            }
        }

        function toggleHistory(event) {
            if (event) event.stopPropagation();
            const p = document.getElementById('history-panel');
            const trigger = document.getElementById('history-trigger');
            const isMinimized = p.classList.toggle('minimized');
            trigger.style.opacity = isMinimized ? "1" : "0";
            if(!isMinimized) fetchHistory();
        }

        // FITUR: Auto Close on Click Outside
        document.addEventListener('click', (event) => {
            const panel = document.getElementById('history-panel');
            const trigger = document.getElementById('history-trigger');
            if (!panel.classList.contains('minimized')) {
                if (!panel.contains(event.target) && !trigger.contains(event.target)) {
                    panel.classList.add('minimized');
                    trigger.style.opacity = "1";
                }
            }
        });

        function renderPumpAnalysis() {
            const container = document.getElementById('pump-tables-container');
            const pumpData = masterStore[currentPump] || { valuesBefore: [], valuesAfter: [] };
            
            const buildTable = (title, type) => {
                const values = (type === 'after' ? pumpData.valuesAfter : pumpData.valuesBefore) || [];
                let allPass = true;
                if (type === 'after') {
                    pumpFlowStd.forEach((item, i) => {
                        const val = values[i];
                        if (!val) { allPass = false; return; }
                        const qc = Math.round((item.np * val) / (item.i * item.ne));
                        const stdBase = parseInt(item.std.split('±')[0]);
                        const stdTol = parseInt(item.std.split('±')[1]);
                        if (qc < (stdBase - stdTol) || qc > (stdBase + stdTol)) allPass = false;
                    });
                }

                return `
                    <div class="glass-card mb-6 ${type === 'after' && values.filter(v => v).length === 5 ? (allPass ? 'border-green-500 shadow-lg' : 'border-red-400') : ''}">
                        <div class="bg-slate-50 p-2 border-b border-slate-100 flex justify-between items-center">
                            <h3 class="text-[9px] font-black text-blue-600 uppercase px-2">${title}</h3>
                            ${type === 'after' && values.filter(v => v).length === 5 ? 
                                `<span class="px-3 py-1 rounded-full text-[8px] font-black uppercase ${allPass ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600 animate-pulse'}">
                                    ${allPass ? '<i class="fas fa-check-circle mr-1"></i> PASS' : '<i class="fas fa-exclamation-triangle mr-1"></i> OUT OF SPEC'}
                                </span>` : ''
                            }
                        </div>
                        <table class="table-custom">
                            <thead>
                                <tr>
                                    <th>Point</th><th>Press</th><th class="text-blue-600">Measured Q</th><th>QC (Calc)</th><th>Standard (QC)</th><th class="opacity-40">Guidance (MQ)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${pumpFlowStd.map((item, i) => {
                                    const val = values[i] || '';
                                    const qc = val ? Math.round((item.np * val) / (item.i * item.ne)) : '-';
                                    let statusColor = 'text-blue-600';
                                    if (type === 'after' && val) {
                                        const stdBase = parseInt(item.std.split('±')[0]);
                                        const stdTol = parseInt(item.std.split('±')[1]);
                                        statusColor = (qc >= (stdBase - stdTol) && qc <= (stdBase + stdTol)) ? 'text-green-600' : 'text-red-500 font-black';
                                    }
                                    return `
                                        <tr>
                                            <td class="font-black">${item.label}</td>
                                            <td class="text-slate-400 italic">${item.p}</td>
                                            <td>
                                                <input type="number" class="input-glacial !p-1 text-center w-20 pump-input" 
                                                    data-type="${type}" data-idx="${i}" value="${val}" 
                                                    oninput="updatePumpValueRealtime(this)" onkeydown="handleKeyNavigation(event)">
                                            </td>
                                            <td class="qc-output ${statusColor}" id="qc-${type}-${i}">${qc}</td>
                                            <td class="font-bold text-slate-500">${item.std}</td>
                                            <td class="opacity-30 italic text-[8px] font-bold">${item.min} - ${item.max}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            };
            container.innerHTML = buildTable('1. BEFORE ADJUSTMENT', 'before') + buildTable('2. AFTER READJUSTMENT', 'after');
            updateChart();
        }

        function updatePumpValueRealtime(el) {
            const type = el.dataset.type;
            const idx = parseInt(el.dataset.idx);
            const val = el.value;
            if(!masterStore[currentPump]) masterStore[currentPump] = { valuesBefore: [], valuesAfter: [] };
            masterStore[currentPump][type === 'after' ? 'valuesAfter' : 'valuesBefore'][idx] = val;
            const item = pumpFlowStd[idx];
            const qcTarget = document.getElementById(`qc-${type}-${idx}`);
            if (qcTarget) {
                const qcVal = val ? Math.round((item.np * val) / (item.i * item.ne)) : '-';
                qcTarget.innerText = qcVal;
                if (type === 'after' && val) {
                    const stdBase = parseInt(item.std.split('±')[0]);
                    const stdTol = parseInt(item.std.split('±')[1]);
                    qcTarget.className = `qc-output ${(qcVal >= (stdBase - stdTol) && qcVal <= (stdBase + stdTol)) ? 'text-green-600' : 'text-red-500 font-black'}`;
                }
            }
            updateChart();
            localStorage.setItem('nik_master_store', JSON.stringify(masterStore));
        }

        async function fetchHistory() {
            const list = document.getElementById('history-list');
            const { data } = await sb.from('pump_performance_reports').select('*').order('created_at', { ascending: false }).limit(10);
            if (data) {
                list.innerHTML = data.map(rec => `
                    <div class="history-item flex justify-between items-center p-2 mb-1 bg-slate-50 rounded-lg border">
                        <div class="overflow-hidden">
                            <p class="text-[10px] font-black uppercase text-slate-800">${rec.unit_model || 'UNIT'}</p>
                            <p class="text-[8px] text-blue-500 font-bold uppercase">${new Date(rec.test_date).toLocaleDateString('id-ID')}</p>
                        </div>
                        <button onclick="loadRecord('${rec.id}')" class="w-7 h-7 bg-white text-blue-600 rounded-lg border flex items-center justify-center hover:bg-blue-600 hover:text-white transition-all">
                            <i class="fas fa-folder-open text-[9px]"></i>
                        </button>
                    </div>`).join('');
            }
        }

        async function loadRecord(id) {
            document.getElementById('loadingOverlay').style.display = 'flex';
            const { data } = await sb.from('pump_performance_reports').select('*').eq('id', id).single();
            if (data) {
                document.getElementById('current_record_id').value = data.id;
                setMode('edit', data.id);
                document.getElementById('unit_model').value = data.unit_model;
                document.getElementById('serial_num').value = data.serial_number;
                document.getElementById('test_date').value = data.test_date;
                document.getElementById('hour_meter').value = data.hour_meter;
                masterStore = data.all_pumps_data || {};
                localStorage.setItem('nik_master_store', JSON.stringify(masterStore));
                const setVal = (sel, vals) => document.querySelectorAll(sel).forEach((el, i) => el.value = vals[i] || '');
                setVal('.data-comp', data.component_history || []);
                setVal('.data-pump', data.pump_relief_values || []);
                setVal('.data-eng', data.engine_speed_values || []);
                setVal('.data-cyc', data.cycle_time_values || []);
                if(!document.getElementById('section-pump').classList.contains('hidden')) renderPumpAnalysis();
                document.getElementById('history-panel').classList.add('minimized');
                document.getElementById('history-trigger').style.opacity = "1";
            }
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function setMode(mode, id = '') {
            const badge = document.getElementById('accessBadge');
            const statusText = document.getElementById('sync-status');
            if (mode === 'edit') {
                badge.className = "status-badge-edit inline-block mt-2 px-2 py-0.5 rounded text-[7px] font-black uppercase tracking-tighter";
                statusText.innerText = "Edit Mode: " + id.substring(0, 8);
            } else {
                badge.className = "status-badge-new inline-block mt-2 px-2 py-0.5 rounded text-[7px] font-black uppercase tracking-tighter";
                statusText.innerText = "New Entry Mode";
            }
        }

        function prepareNewEntry() {
            document.getElementById('current_record_id').value = "";
            setMode('new');
            document.querySelectorAll('.input-glacial:not(.input-readonly)').forEach(i => i.value = "");
            document.getElementById('test_date').valueAsDate = new Date();
            masterStore = {};
            localStorage.removeItem('nik_master_store');
            renderPumpAnalysis();
        }

        function initGeneralForms() {
            const comps = ["ENGINE", "PUMP 1-2", "PUMP 3-4", "PUMP 5-6", "PUMP 7-8"];
            document.getElementById('comp-history-body').innerHTML = comps.map(c => `<tr><td class="p-2 font-black text-[9px] text-slate-700 pl-4 bg-slate-50/50">${c}</td><td><input type="text" class="input-glacial !p-1.5 border-0 data-comp" onkeydown="handleKeyNavigation(event)"></td><td><input type="text" class="input-glacial !p-1.5 border-0 data-comp" onkeydown="handleKeyNavigation(event)"></td><td><input type="number" class="input-glacial !p-1.5 border-0 data-comp" onkeydown="handleKeyNavigation(event)"></td><td><input type="text" class="input-glacial !p-1.5 border-0 data-comp" onkeydown="handleKeyNavigation(event)"></td></tr>`).join('');
            document.getElementById('pump-relief-grid').innerHTML = Array.from({length:8}, (_,i)=>`<div><label class="text-[9px] font-black text-slate-400 mb-1 block">P${i+1}</label><input type="number" class="input-glacial text-center data-pump" onkeydown="handleKeyNavigation(event)"></div>`).join('');
            const engData = [{n: "Low Idle", s: "780-820"}, {n: "High Idle", s: "1850-1950"}, {n: "Auto Idle", s: "1350-1450"}, {n: "Relief Idle", s: "1770-1830"}];
            document.getElementById('engine-speed-body').innerHTML = engData.map(e => `<tr><td class="p-3 font-bold text-slate-700 text-[10px] pl-4">${e.n}</td><td class="text-[10px] font-bold text-slate-400">${e.s}</td><td class="p-1"><input type="number" class="input-glacial data-eng text-center" onkeydown="handleKeyNavigation(event)"></td><td class="p-1"><input type="number" class="input-glacial data-eng text-center" onkeydown="handleKeyNavigation(event)"></td></tr>`).join('');
            const actions = [{n: "Boom Raise", s: "8.2±0.5"},{n: "Arm Roll-in", s: "7.0±0.5"},{n: "Arm Roll-out", s: "7.0±0.5"},{n: "Bucket Roll-in", s: "4.7±0.5"},{n: "Bucket Roll-out", s: "4.2±0.5"},{n: "Swing RH", s: "57±3"},{n: "Swing LH", s: "57±3"}];
            document.getElementById('cycle-time-body').innerHTML = actions.map(a => `<tr><td class="text-[9px] text-left font-black p-2 pl-4 text-slate-700 bg-slate-50/30">${a.n}</td><td class="std-text">${a.s}</td><td class="p-1"><input type="number" step="0.1" class="input-glacial text-center data-cyc" onkeydown="handleKeyNavigation(event)"></td><td class="p-1"><input type="number" step="0.1" class="input-glacial text-center data-cyc" onkeydown="handleKeyNavigation(event)"></td></tr>`).join('');
        }

        async function saveToCloud() {
            document.getElementById('loadingOverlay').style.display = 'flex';
            const recId = document.getElementById('current_record_id').value;
            const record = {
                test_date: document.getElementById('test_date').value,
                nik: document.getElementById('nik').value,
                unit_model: document.getElementById('unit_model').value,
                serial_number: document.getElementById('serial_num').value,
                hour_meter: document.getElementById('hour_meter').value,
                component_history: Array.from(document.querySelectorAll('.data-comp')).map(i => i.value),
                pump_relief_values: Array.from(document.querySelectorAll('.data-pump')).map(i => i.value),
                engine_speed_values: Array.from(document.querySelectorAll('.data-eng')).map(i => i.value),
                cycle_time_values: Array.from(document.querySelectorAll('.data-cyc')).map(i => i.value),
                all_pumps_data: masterStore
            };
            let res = recId ? await sb.from('pump_performance_reports').update(record).eq('id', recId) : await sb.from('pump_performance_reports').insert([record]);
            document.getElementById('loadingOverlay').style.display = 'none';
            if (res.error) alert("Sync Error!"); else { alert("✅ Synchronized!"); prepareNewEntry(); fetchHistory(); switchTab('general'); }
        }

        function initChart() {
            const ctx = document.getElementById('nikChart').getContext('2d');
            if (nikChart) nikChart.destroy();
            nikChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: pumpFlowStd.map(d => d.label),
                    datasets: [
                        { label: 'Min Std', data: pumpFlowStd.map(item => parseInt(item.std.split('±')[0]) - parseInt(item.std.split('±')[1])), borderColor: '#facc15', borderDash: [5,5], pointRadius: 0, fill: false },
                        { label: 'Max Std', data: pumpFlowStd.map(item => parseInt(item.std.split('±')[0]) + parseInt(item.std.split('±')[1])), borderColor: '#ef4444', borderDash: [5,5], pointRadius: 0, fill: false },
                        { label: 'Before', data: [], borderColor: '#94a3b8', tension: 0.3, pointRadius: 4, fill: false },
                        { label: 'After', data: [], borderColor: '#3b82f6', tension: 0.3, pointRadius: 4, fill: false }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function updateChart() {
            if(!nikChart) return;
            const pumpData = masterStore[currentPump] || { valuesBefore: [], valuesAfter: [] };
            const calcQC = (v, i) => v ? Math.round((pumpFlowStd[i].np * v) / (pumpFlowStd[i].i * pumpFlowStd[i].ne)) : null;
            nikChart.data.datasets[2].data = (pumpData.valuesBefore || []).map((v, i) => calcQC(v, i));
            nikChart.data.datasets[3].data = (pumpData.valuesAfter || []).map((v, i) => calcQC(v, i));
            nikChart.update();
        }

        function switchTab(t) {
            document.getElementById('section-general').classList.toggle('hidden', t !== 'general');
            document.getElementById('section-pump').classList.toggle('hidden', t !== 'pump');
            document.getElementById('tab-gen').classList.toggle('active', t === 'general');
            document.getElementById('tab-pump').classList.toggle('active', t === 'pump');
            if(t === 'pump') { if(!nikChart) initChart(); renderPumpAnalysis(); }
        }

        function changePump(v) { currentPump = v; document.getElementById('active-p-num').innerText = v; renderPumpAnalysis(); }

        window.onload = () => {
            initGeneralForms();
            document.getElementById('display-nik').innerText = localStorage.getItem('userNIK') || 'GUEST';
            document.getElementById('nik').value = localStorage.getItem('userNIK') || 'GUEST';
            document.getElementById('nama_pic').value = localStorage.getItem('fullName') || 'Unknown';
            document.getElementById('test_date').valueAsDate = new Date();
            runAutoScale();
            window.addEventListener('resize', runAutoScale);
            document.addEventListener('keydown', (e) => { if(e.target.tagName === 'INPUT') handleKeyNavigation(e); });
            fetchHistory();
        };
    </script>
</body>
</html>
