<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toolbox Pro | Hexindo Fleet</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --hex-yellow: #ffc107; 
            --hex-dark: #1a1d20; 
            --bg-body: #f0f2f5;
            --success: #198754; 
            --warning: #ffc107; 
            --danger: #dc3545;
            --card-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        html { display: none; }

        body { 
            font-family: 'Inter', -apple-system, sans-serif; 
            margin: 0; padding: 10px; 
            background: var(--bg-body); 
            color: #334155;
            font-size: 11px;
        }

        .container { max-width: 1400px; margin: auto; }

        .top-bar { 
            background: var(--hex-dark); color: white; 
            padding: 15px; border-radius: 14px; 
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; box-shadow: var(--card-shadow);
            border-bottom: 4px solid var(--hex-yellow);
        }

        .brand-section { display: flex; align-items: center; gap: 10px; }
        .btn-home { background: var(--hex-yellow); border: none; padding: 10px; border-radius: 10px; cursor: pointer; }

        .role-indicator { font-size: 9px; font-weight: 800; text-transform: uppercase; color: #94a3b8; }

        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .s-card { background: white; padding: 15px; border-radius: 16px; text-align: center; box-shadow: var(--card-shadow); }
        .s-card.baik { border-bottom: 5px solid var(--success); }
        .s-card.rusak { border-bottom: 5px solid var(--warning); }
        .s-card.hilang { border-bottom: 5px solid var(--danger); }
        .s-val { font-size: 24px; font-weight: 900; display: block; }
        .s-label { font-size: 9px; text-transform: uppercase; font-weight: 800; color: #64748b; }

        /* PERBAIKAN GRID META CARD */
        .meta-card { 
            background: white; padding: 20px; border-radius: 16px; 
            display: grid; grid-template-columns: 1fr; /* Default mobile 1 kolom */
            gap: 15px; margin-bottom: 20px; box-shadow: var(--card-shadow);
        }
        @media (min-width: 768px) {
            .meta-card { grid-template-columns: repeat(4, 1fr); }
        }

        .input-group label { display: block; margin-bottom: 8px; font-weight: 800; color: #475569; font-size: 10px; text-transform: uppercase; }
        input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 12px; font-weight: 600; box-sizing: border-box; }
        .readonly-bg { background: #f1f5f9; color: #475569; border: none; }

        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 25px; }
        @media (min-width: 768px) { .btn-group { grid-template-columns: repeat(4, 1fr); } }

        .btn-group button { 
            padding: 16px; border: none; border-radius: 12px; 
            font-weight: 900; cursor: pointer; color: white;
            text-transform: uppercase; font-size: 10px;
        }
        .btn-save { background: var(--hex-dark); border: 2px solid var(--hex-yellow) !important; color: var(--hex-yellow) !important; }
        .btn-pull { background: #7c3aed; }
        .btn-check { background: #0ea5e9; }
        .btn-new { background: #64748b; }

        .main-grid { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 30px; }
        @media (min-width: 1024px) { .main-grid { grid-template-columns: 1fr 1fr; } }

        .table-container { background: white; border-radius: 16px; overflow: hidden; box-shadow: var(--card-shadow); border: 1px solid #e2e8f0; }
        .scroll-area { height: 400px; overflow-y: auto; }
        
        table { width: 100%; border-collapse: collapse; }
        th { background: #1a1d20; color: white; padding: 12px; font-size: 9px; text-transform: uppercase; position: sticky; top: 0; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; }

        .row-highlight { background-color: #fee2e2 !important; transition: 0.5s; }
        .history-card { background: white; padding: 20px; border-radius: 16px; box-shadow: var(--card-shadow); overflow-x: auto; }
    </style>
</head>
<body>

<div class="container">
    <div class="top-bar">
        <div class="brand-section">
            <button class="btn-home" onclick="window.location.href='index.html'">üè†</button>
            <div>
                <h2 style="margin:0; font-size: 16px; font-weight: 900;">TOOLBOX <span style="color:var(--hex-yellow)">PRO</span></h2>
                <div class="role-indicator" id="roleText">Access: Checking...</div>
            </div>
        </div>
        <div id="currentMonthBadge" style="background:rgba(255,255,255,0.1); padding:8px 12px; border-radius:8px; font-weight:900; border:1px solid var(--hex-yellow); font-size:10px;">FEB 2026</div>
    </div>

    <div class="summary-grid">
        <div class="s-card baik"><span class="s-val" id="countB" style="color:var(--success)">0</span><span class="s-label">Baik</span></div>
        <div class="s-card rusak"><span class="s-val" id="countR" style="color:#d97706">0</span><span class="s-label">Rusak</span></div>
        <div class="s-card hilang"><span class="s-val" id="countH" style="color:#dc3545">0</span><span class="s-label">Hilang</span></div>
    </div>

    <input type="hidden" id="editingId" value="">

    <div class="meta-card">
        <div class="input-group"><label>NIK Teknisi</label><input type="text" id="asset" class="readonly-bg" readonly></div>
        <div class="input-group"><label>Nama Lengkap</label><input type="text" id="pic" class="readonly-bg" readonly></div>
        <div class="input-group"><label>Tanggal Inspeksi</label><input type="date" id="tgl" onchange="updateMonthBadge()"></div>
        <div class="input-group"><label>Lokasi Kerja</label><input type="text" id="branch" value="ADARO PROJECT" class="readonly-bg" readonly></div>
    </div>

    <div class="btn-group">
        <button class="btn-save" onclick="prosesSimpan()" id="btnSubmit">‚òÅÔ∏è Sync Cloud</button>
        <button class="btn-pull" onclick="fetchHistory()">üîÑ Pull Cloud</button>
        <button class="btn-check" onclick="checkAllBaik()">‚úÖ All Baik</button>
        <button class="btn-new" onclick="resetForm()">‚ûï New</button>
    </div>

    <div class="main-grid">
        <div class="table-container">
            <div class="scroll-area">
                <table>
                    <thead><tr><th width="30">No</th><th>Item (1-53)</th><th width="30">B</th><th width="30">R</th><th width="30">H</th></tr></thead>
                    <tbody id="area1"></tbody>
                </table>
            </div>
        </div>
        <div class="table-container">
            <div class="scroll-area">
                <table>
                    <thead><tr><th width="30">No</th><th>Item (54-106)</th><th width="30">B</th><th width="30">R</th><th width="30">H</th></tr></thead>
                    <tbody id="area2"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="history-card">
        <h3 style="margin:0; font-size:12px; text-transform:uppercase; font-weight:900;">üìã Cloud Records</h3>
        <table style="width:100%; margin-top:15px; min-width:600px;">
            <thead>
                <tr style="background:#f8fafc; text-align:left;">
                    <th>Date</th>
                    <th>NIK</th>
                    <th>Name</th>
                    <th>Summary</th>
                    <th style="text-align:right;">Action</th>
                </tr>
            </thead>
            <tbody id="histBody"></tbody>
        </table>
        <div id="loader" style="display:none; text-align:center; padding:20px; font-weight:bold; color:var(--hex-yellow)">Syncing...</div>
    </div>
</div>

<script>
    const userRole = localStorage.getItem('userRole') || 'technician';
    const userNrp = localStorage.getItem('userNRP');
    const userName = localStorage.getItem('userName');

    if (localStorage.getItem('isLoggedIn') !== 'true') {
        window.location.href = 'login.html';
    } else {
        document.documentElement.style.display = 'block';
        document.getElementById('roleText').innerText = userRole === 'admin' ? "üõ°Ô∏è Admin" : `üîß ${userName}`;
    }

    const listAlat = ["Adjustable wrench L=12\"", "Adjustable wrench pipe L=10\"", "Allen key 12mm", "Allen key 14mm", "Allen key 17mm", "Allen key set 2-10mm", "Brush steel W=30mm", "Catridge belt wrench 125mm", "Chisel plate W=11 L=140mm", "Combination wrench 24mm", "Combination wrench 27mm", "Combination wrench 30mm", "Combination wrench 32mm", "Combination wrench 36mm", "Combination wrench 41mm", "Extention socket 1/2\" L=10\"", "Extention socket 1/2\" L=5\"", "Extention socket 3/4\" L=18\"", "Extention socket 3/4\" L=8\"", "Extention socket 1/2\" U-joint", "Feeler gauge set", "Files set (5 pcs) 150mm", "Files plate type 250mm", "Files round type 250mm", "Haksaw iron & blade", "Half moon wrench 14x17", "Half moon wrench 19x22", "Hammer besi 0.5kg", "Hammer karet 0.5kg", "Hammer plastik 0.5kg", "Handle socket T 1/2\"", "Handle socket T 3/4\"", "Handle rachet 1/2\"", "Handle rachet 3/4\"", "Magnetic stick L=50cm", "Multitester CD 800", "Open end 6x7", "Open end 8x9", "Open end 10x11", "Open end 12x13", "Open end 14x15", "Open end 16x17", "Open end 18x19", "Open end 20x22", "Open end 24x26", "Open end 36x41", "Paint brush", "Pliers combination 200mm", "Pliers side cutting 200mm", "Pliers water pump", "Pliers viece grip", "Pliers snap ring (in)", "Pliers snap ring (out)", "Pry bar L=40cm", "Punch drift 150mm", "Punch center 130mm", "Ring spanner 6x7", "Ring spanner 8x9", "Ring spanner 10x11", "Ring spanner 12x13", "Ring spanner 14x15", "Ring spanner 16x17", "Ring spanner 18x19", "Ring spanner 20x22", "Ring spanner 24x26", "Scale meter roll 2.5m", "Scrape blade W=25mm", "Screw drive plus 75mm", "Screw drive plus 100mm", "Screw drive plus 125mm", "Screw drive plus 150mm", "Screw drive plate 75mm", "Screw drive plate 100mm", "Screw drive plate 150mm", "Screw drive plate 200mm", "Socket (12) 1/2\" 10mm", "Socket (12) 1/2\" 11mm", "Socket (12) 1/2\" 12mm", "Socket (12) 1/2\" 13mm", "Socket (12) 1/2\" 14mm", "Socket (12) 1/2\" 15mm", "Socket (12) 1/2\" 16mm", "Socket (12) 1/2\" 17mm", "Socket (12) 1/2\" 18mm", "Socket (12) 1/2\" 19mm", "Socket (12) 1/2\" 20mm", "Socket (12) 1/2\" 21mm", "Socket (12) 1/2\" 22mm", "Socket (12) 3/4\" 22mm", "Socket (12) 3/4\" 23mm", "Socket (12) 3/4\" 24mm", "Socket (12) 3/4\" 27mm", "Socket (12) 3/4\" 28mm", "Socket (12) 3/4\" 29mm", "Socket (12) 3/4\" 30mm", "Socket (12) 3/4\" 32mm", "Socket (12) 3/4\" 36mm", "Socket (12) 3/4\" 38mm", "Socket (12) 3/4\" 41mm", "Socket (12) 3/4\" 46mm", "Stop watch digital", "Thermometer 0-200C", "Treeds gauge set", "Tools box 3 step", "Test pen DC", "Vernier caliper 150mm"];

    const SB_URL = "https://corpgiuxyhfxdnqwwmlv.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNvcnBnaXV4eWhmeGRucXd3bWx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDMwNzcsImV4cCI6MjA4NTg3OTA3N30.PMp5yZOISYrBG0UUcIGaXUPnmEAaWVKgQ3Y1W8Nea_E";
    const sbClient = supabase.createClient(SB_URL, SB_KEY);

    function refreshSummary() {
        let b = 0, r = 0, h = 0;
        listAlat.forEach((_, i) => {
            const rad = document.querySelector(`input[name="t-${i+1}"]:checked`);
            if(rad) {
                if(rad.value === "B") b++; else if(rad.value === "R") r++; else h++;
            }
        });
        document.getElementById('countB').innerText = b;
        document.getElementById('countR').innerText = r;
        document.getElementById('countH').innerText = h;
    }

    function checkAllBaik() {
        listAlat.forEach((_, i) => {
            const radB = document.querySelector(`input[name="t-${i+1}"][value="B"]`);
            if(radB) radB.checked = true;
        });
        refreshSummary();
    }

    function updateMonthBadge() {
        const tglInput = document.getElementById('tgl').value;
        if(!tglInput) return;
        const d = new Date(tglInput);
        const months = ["JAN", "FEB", "MAR", "APR", "MEI", "JUN", "JUL", "AGU", "SEP", "OKT", "NOV", "DES"];
        document.getElementById('currentMonthBadge').innerText = months[d.getMonth()] + " " + d.getFullYear();
    }

    const area1 = document.getElementById('area1'), area2 = document.getElementById('area2');
    listAlat.forEach((name, i) => {
        const no = i + 1;
        const html = `<tr id="row-${no}"><td>${no}</td><td style="font-weight:700;">${name}</td><td><input type="radio" name="t-${no}" value="B" onclick="refreshSummary()"></td><td><input type="radio" name="t-${no}" value="R" onclick="refreshSummary()"></td><td><input type="radio" name="t-${no}" value="H" onclick="refreshSummary()"></td></tr>`;
        if(no <= 53) area1.innerHTML += html; else area2.innerHTML += html;
    });

    async function prosesSimpan() {
        const btn = document.getElementById('btnSubmit');
        const values = listAlat.map((_, i) => {
            const rad = document.querySelector(`input[name="t-${i+1}"]:checked`);
            return rad ? rad.value : null;
        });

        // FITUR AUTO SCROLL VALIDASI
        if(values.includes(null)) {
            const firstEmpty = values.indexOf(null) + 1;
            const target = document.getElementById(`row-${firstEmpty}`);
            target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            target.classList.add('row-highlight');
            setTimeout(() => target.classList.remove('row-highlight'), 2000);
            return alert(`‚ö†Ô∏è Item No. ${firstEmpty} belum diperiksa!`);
        }

        btn.disabled = true;
        const payload = {
            nik: document.getElementById('asset').value,
            pic_name: document.getElementById('pic').value,
            check_date: document.getElementById('tgl').value,
            branch: document.getElementById('branch').value,
            items_data: values
        };

        const editingId = document.getElementById('editingId').value;
        let res = editingId ? await sbClient.from('toolbox_reports').update(payload).eq('id', editingId) : await sbClient.from('toolbox_reports').insert([payload]);

        if(res.error) alert(res.error.message);
        else { alert("‚úÖ Berhasil Sinkron!"); fetchHistory(); resetForm(); }
        btn.disabled = false;
    }

    async function fetchHistory() {
        document.getElementById('loader').style.display = 'block';
        let query = sbClient.from('toolbox_reports').select('*');
        if (userRole !== 'admin') query = query.eq('nik', userNrp);
        const { data } = await query.order('check_date', { ascending: false }).limit(10);
        
        document.getElementById('loader').style.display = 'none';
        const histBody = document.getElementById('histBody');
        histBody.innerHTML = "";
        if(data) {
            data.forEach(row => {
                const b = row.items_data.filter(x => x==='B').length;
                const r = row.items_data.filter(x => x==='R').length;
                const h = row.items_data.filter(x => x==='H').length;
                histBody.innerHTML += `<tr>
                    <td>${row.check_date}</td>
                    <td>${row.nik}</td>
                    <td>${row.pic_name}</td>
                    <td>B:${b} R:${r} H:${h}</td>
                    <td style="text-align:right"><button onclick='loadData(${JSON.stringify(row)})'>Edit</button></td>
                </tr>`;
            });
        }
    }

    function loadData(row) {
        document.getElementById('editingId').value = row.id;
        document.getElementById('asset').value = row.nik;
        document.getElementById('pic').value = row.pic_name;
        document.getElementById('tgl').value = row.check_date;
        row.items_data.forEach((val, i) => {
            document.querySelector(`input[name="t-${i+1}"][value="${val}"]`).checked = true;
        });
        refreshSummary(); updateMonthBadge();
        window.scrollTo({top: 0, behavior: 'smooth'});
    }

    function resetForm() {
        document.getElementById('editingId').value = "";
        document.getElementById('asset').value = userNrp;
        document.getElementById('pic').value = userName;
        document.getElementById('tgl').valueAsDate = new Date();
        document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
        refreshSummary(); updateMonthBadge();
    }

    document.getElementById('tgl').valueAsDate = new Date();
    document.getElementById('asset').value = userNrp;
    document.getElementById('pic').value = userName;
    updateMonthBadge();
    fetchHistory();
</script>
</body>
</html>
