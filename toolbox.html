<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toolbox Pro | Hexindo Fleet</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=JetBrains+Mono:wght@700&display=swap');
        
        html { display: none; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: linear-gradient(135deg, #d1e3ff 0%, #a2c2e8 100%);
            min-height: 100vh;
            color: #1e293b;
            overflow-x: hidden;
            position: relative;
        }

        /* --- ENGINE BADAI SALJU BESAR --- */
        .snow-storm {
            position: fixed;
            top: -50px;
            background: white;
            border-radius: 50%;
            z-index: 1;
            pointer-events: none;
            animation: stormRun linear infinite;
            filter: blur(1px);
            box-shadow: 0 0 10px 2px rgba(255, 255, 255, 0.8);
        }
        @keyframes stormRun {
            0% { transform: translateY(0) translateX(0) scale(1); opacity: 0; }
            20% { opacity: 1; }
            100% { transform: translateY(110vh) translateX(100px) scale(0.5); opacity: 0; }
        }

        /* Glass Ice Effect */
        .glass-ice {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.12);
            position: relative;
            z-index: 10; /* Menaruh UI di depan badai */
        }

        .input-glass {
            background: rgba(255, 255, 255, 0.6) !important;
            border: 1px solid rgba(255, 255, 255, 0.8) !important;
            border-radius: 12px;
            padding: 10px 14px;
            font-size: 0.85rem;
            transition: 0.3s;
        }

        .scroll-area { 
            height: 450px; 
            overflow-y: auto; 
            scrollbar-width: thin;
            scrollbar-color: rgba(59, 130, 246, 0.3) transparent;
        }

        th { 
            background: rgba(255, 255, 255, 0.9); 
            position: sticky; top: 0; z-index: 20;
            font-size: 9px; text-transform: uppercase; color: #1e293b;
            padding: 12px 8px; border-bottom: 2px solid rgba(59, 130, 246, 0.2);
        }

        tr:nth-child(even) { background: rgba(255, 255, 255, 0.2); }
        
        .row-highlight { 
            background-color: rgba(239, 68, 68, 0.3) !important; 
            outline: 2px solid #ef4444;
        }

        input[type="radio"] {
            width: 20px; height: 20px; cursor: pointer;
            accent-color: #2563eb;
        }
    </style>
</head>
<body class="p-2 md:p-6">

<div id="storm-container" class="fixed inset-0 pointer-events-none"></div>

<div class="max-w-[1400px] mx-auto space-y-6 relative z-10">
    
    <header class="glass-ice p-5 rounded-[2.5rem] flex flex-wrap justify-between items-center gap-4">
        <div class="flex items-center gap-4">
            <button onclick="window.location.href='index.html'" class="h-12 w-12 bg-white/70 hover:bg-white rounded-2xl flex items-center justify-center text-slate-700 transition-all shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
            </button>
            <div>
                <h1 class="text-xl font-black text-slate-800 tracking-tighter uppercase italic leading-none">Toolbox <span class="text-blue-600">Pro</span></h1>
                <p id="roleText" class="text-[9px] text-blue-600 font-bold uppercase tracking-widest mt-1">NIK: Verifying...</p>
            </div>
        </div>
        <div id="currentMonthBadge" class="bg-blue-600 text-white px-5 py-2 rounded-xl font-black text-[10px] uppercase shadow-lg shadow-blue-500/30">FEB 2026</div>
    </header>

    <div class="grid grid-cols-3 gap-4">
        <div class="glass-ice p-4 rounded-3xl text-center border-b-4 border-emerald-500">
            <span class="block text-2xl font-black text-emerald-600" id="countB">0</span>
            <span class="text-[9px] font-bold text-slate-500 uppercase">Kondisi Baik</span>
        </div>
        <div class="glass-ice p-4 rounded-3xl text-center border-b-4 border-yellow-500">
            <span class="block text-2xl font-black text-yellow-600" id="countR">0</span>
            <span class="text-[9px] font-bold text-slate-500 uppercase">Rusak</span>
        </div>
        <div class="glass-ice p-4 rounded-3xl text-center border-b-4 border-red-500">
            <span class="block text-2xl font-black text-red-600" id="countH">0</span>
            <span class="text-[9px] font-bold text-slate-500 uppercase">Hilang</span>
        </div>
    </div>

    <div class="glass-ice p-8 rounded-[3rem] grid grid-cols-1 md:grid-cols-4 gap-6">
        <input type="hidden" id="editingId">
        <div>
            <label class="text-[9px] font-black uppercase text-slate-500 mb-2 ml-1 block">NIK Teknisi</label>
            <input type="text" id="asset" class="input-glass w-full font-mono text-blue-700" readonly>
        </div>
        <div>
            <label class="text-[9px] font-black uppercase text-slate-500 mb-2 ml-1 block">Nama Lengkap</label>
            <input type="text" id="pic" class="input-glass w-full uppercase font-bold" readonly>
        </div>
        <div>
            <label class="text-[9px] font-black uppercase text-slate-500 mb-2 ml-1 block">Tanggal Inspeksi</label>
            <input type="date" id="tgl" onchange="updateMonthBadge()" class="input-glass w-full font-bold">
        </div>
        <div>
            <label class="text-[9px] font-black uppercase text-slate-500 mb-2 ml-1 block">Lokasi Kerja</label>
            <input type="text" id="branch" value="ADARO PROJECT" class="input-glass w-full uppercase" readonly>
        </div>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <button onclick="prosesSimpan()" id="btnSubmit" class="bg-blue-600 text-white p-4 rounded-2xl font-black text-[10px] uppercase shadow-xl shadow-blue-500/20 active:scale-95 transition-all">‚òÅÔ∏è Sync Cloud</button>
        <button onclick="fetchHistory()" class="bg-white/80 text-slate-700 p-4 rounded-2xl font-black text-[10px] uppercase border border-white active:scale-95 transition-all">üîÑ Pull Cloud</button>
        <button onclick="checkAllBaik()" class="bg-emerald-500 text-white p-4 rounded-2xl font-black text-[10px] uppercase shadow-lg shadow-emerald-500/20 active:scale-95 transition-all">‚úÖ All Baik</button>
        <button onclick="resetForm()" class="bg-slate-800 text-white p-4 rounded-2xl font-black text-[10px] uppercase active:scale-95 transition-all">‚ûï Reset / New</button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="glass-ice rounded-[2.5rem] overflow-hidden">
            <div class="scroll-area p-2">
                <table class="w-full">
                    <thead><tr><th width="40">No</th><th class="text-left">Item Tools (1-53)</th><th width="45">B</th><th width="45">R</th><th width="45">H</th></tr></thead>
                    <tbody id="area1" class="text-[11px]"></tbody>
                </table>
            </div>
        </div>
        <div class="glass-ice rounded-[2.5rem] overflow-hidden">
            <div class="scroll-area p-2">
                <table class="w-full">
                    <thead><tr><th width="40">No</th><th class="text-left">Item Tools (54-106)</th><th width="45">B</th><th width="45">R</th><th width="45">H</th></tr></thead>
                    <tbody id="area2" class="text-[11px]"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="glass-ice p-8 rounded-[3rem]">
        <h3 class="text-xs font-black uppercase italic tracking-widest text-slate-800 mb-6 flex items-center gap-2">
            <span class="w-2 h-6 bg-blue-600 rounded-full"></span> üìã Cloud History Records
        </h3>
        <div class="overflow-x-auto">
            <table class="w-full min-w-[700px]">
                <thead>
                    <tr class="text-left text-[9px] uppercase text-slate-400 border-b border-white/50">
                        <th class="py-4">Date</th><th>NIK</th><th>Name</th><th>Summary</th><th class="text-right">Action</th>
                    </tr>
                </thead>
                <tbody id="histBody" class="text-[11px] font-bold"></tbody>
            </table>
        </div>
        <div id="loader" class="hidden text-center p-10 font-black text-blue-600 italic animate-pulse">SYNCING DATA...</div>
    </div>
</div>

<script>
    // --- ENGINE BADAI SALJU BESAR ---
    function initSnowStorm() {
        const container = document.getElementById('storm-container');
        const flakeCount = 100; // Jumlah partikel banyak untuk kesan badai
        for (let i = 0; i < flakeCount; i++) {
            const flake = document.createElement('div');
            flake.className = 'snow-storm';
            
            const size = Math.random() * 5 + 2;
            flake.style.width = size + 'px';
            flake.style.height = size + 'px';
            flake.style.left = Math.random() * 110 + 'vw';
            flake.style.animationDuration = (Math.random() * 1 + 0.5) + 's'; // Sangat cepat
            flake.style.animationDelay = (Math.random() * 5) + 's';
            flake.style.opacity = Math.random();
            
            container.appendChild(flake);
        }
    }
    initSnowStorm();

    const userRole = localStorage.getItem('userRole') || 'technician';
    const userNrp = localStorage.getItem('userNRP');
    const userName = localStorage.getItem('userName');

    if (localStorage.getItem('isLoggedIn') !== 'true') {
        window.location.href = 'login.html';
    } else {
        document.documentElement.style.display = 'block';
        document.getElementById('roleText').innerText = `NIK: ${userNrp} | ${userName}`;
    }

    const listAlat = ["Adjustable wrench L=12\"", "Adjustable wrench pipe L=10\"", "Allen key 12mm", "Allen key 14mm", "Allen key 17mm", "Allen key set 2-10mm", "Brush steel W=30mm", "Catridge belt wrench 125mm", "Chisel plate W=11 L=140mm", "Combination wrench 24mm", "Combination wrench 27mm", "Combination wrench 30mm", "Combination wrench 32mm", "Combination wrench 36mm", "Combination wrench 41mm", "Extention socket 1/2\" L=10\"", "Extention socket 1/2\" L=5\"", "Extention socket 3/4\" L=18\"", "Extention socket 3/4\" L=8\"", "Extention socket 1/2\" U-joint", "Feeler gauge set", "Files set (5 pcs) 150mm", "Files plate type 250mm", "Files round type 250mm", "Haksaw iron & blade", "Half moon wrench 14x17", "Half moon wrench 19x22", "Hammer besi 0.5kg", "Hammer karet 0.5kg", "Hammer plastik 0.5kg", "Handle socket T 1/2\"", "Handle socket T 3/4\"", "Handle rachet 1/2\"", "Handle rachet 3/4\"", "Magnetic stick L=50cm", "Multitester CD 800", "Open end 6x7", "Open end 8x9", "Open end 10x11", "Open end 12x13", "Open end 14x15", "Open end 16x17", "Open end 18x19", "Open end 20x22", "Open end 24x26", "Open end 36x41", "Paint brush", "Pliers combination 200mm", "Pliers side cutting 200mm", "Pliers water pump", "Pliers viece grip", "Pliers snap ring (in)", "Pliers snap ring (out)", "Pry bar L=40cm", "Punch drift 150mm", "Punch center 130mm", "Ring spanner 6x7", "Ring spanner 8x9", "Ring spanner 10x11", "Ring spanner 12x13", "Ring spanner 14x15", "Ring spanner 16x17", "Ring spanner 18x19", "Ring spanner 20x22", "Ring spanner 24x26", "Scale meter roll 2.5m", "Scrape blade W=25mm", "Screw drive plus 75mm", "Screw drive plus 100mm", "Screw drive plus 125mm", "Screw drive plus 150mm", "Screw drive plate 75mm", "Screw drive plate 100mm", "Screw drive plate 150mm", "Screw drive plate 200mm", "Socket (12) 1/2\" 10mm", "Socket (12) 1/2\" 11mm", "Socket (12) 1/2\" 12mm", "Socket (12) 1/2\" 13mm", "Socket (12) 1/2\" 14mm", "Socket (12) 1/2\" 15mm", "Socket (12) 1/2\" 16mm", "Socket (12) 1/2\" 17mm", "Socket (12) 1/2\" 18mm", "Socket (12) 1/2\" 19mm", "Socket (12) 1/2\" 20mm", "Socket (12) 1/2\" 21mm", "Socket (12) 1/2\" 22mm", "Socket (12) 3/4\" 22mm", "Socket (12) 3/4\" 23mm", "Socket (12) 3/4\" 24mm", "Socket (12) 3/4\" 27mm", "Socket (12) 3/4\" 28mm", "Socket (12) 3/4\" 29mm", "Socket (12) 3/4\" 30mm", "Socket (12) 3/4\" 32mm", "Socket (12) 3/4\" 36mm", "Socket (12) 3/4\" 38mm", "Socket (12) 3/4\" 41mm", "Socket (12) 3/4\" 46mm", "Stop watch digital", "Thermometer 0-200C", "Treeds gauge set", "Tools box 3 step", "Test pen DC", "Vernier caliper 150mm"];

    const SB_URL = "https://corpgiuxyhfxdnqwwmlv.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNvcnBnaXV4eWhmeGRucXd3bWx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDMwNzcsImV4cCI6MjA4NTg3OTA3N30.PMp5yZOISYrBG0UUcIGaXUPnmEAaWVKgQ3Y1W8Nea_E";
    const sbClient = supabase.createClient(SB_URL, SB_KEY);

    // BUILD TABLE
    const area1 = document.getElementById('area1'), area2 = document.getElementById('area2');
    listAlat.forEach((name, i) => {
        const no = i + 1;
        const html = `<tr id="row-${no}" class="border-b border-white/20 transition-all hover:bg-white/10">
            <td class="text-center py-3 font-bold text-slate-500">${no}</td>
            <td class="font-bold text-slate-700 uppercase">${name}</td>
            <td class="text-center"><input type="radio" name="t-${no}" value="B" onclick="refreshSummary()"></td>
            <td class="text-center"><input type="radio" name="t-${no}" value="R" onclick="refreshSummary()"></td>
            <td class="text-center"><input type="radio" name="t-${no}" value="H" onclick="refreshSummary()"></td>
        </tr>`;
        if(no <= 53) area1.innerHTML += html; else area2.innerHTML += html;
    });

    function refreshSummary() {
        let b = 0, r = 0, h = 0;
        listAlat.forEach((_, i) => {
            const rad = document.querySelector(`input[name="t-${i+1}"]:checked`);
            if(rad) {
                if(rad.value === "B") b++; else if(rad.value === "R") r++; else h++;
            }
        });
        document.getElementById('countB').innerText = b;
        document.getElementById('countR').innerText = r;
        document.getElementById('countH').innerText = h;
    }

    function checkAllBaik() {
        listAlat.forEach((_, i) => {
            const radB = document.querySelector(`input[name="t-${i+1}"][value="B"]`);
            if(radB) radB.checked = true;
        });
        refreshSummary();
    }

    function updateMonthBadge() {
        const tglInput = document.getElementById('tgl').value;
        if(!tglInput) return;
        const d = new Date(tglInput);
        const months = ["JAN", "FEB", "MAR", "APR", "MEI", "JUN", "JUL", "AGU", "SEP", "OKT", "NOV", "DES"];
        document.getElementById('currentMonthBadge').innerText = months[d.getMonth()] + " " + d.getFullYear();
    }

    async function prosesSimpan() {
        const btn = document.getElementById('btnSubmit');
        const values = listAlat.map((_, i) => {
            const rad = document.querySelector(`input[name="t-${i+1}"]:checked`);
            return rad ? rad.value : null;
        });

        if(values.includes(null)) {
            const firstEmpty = values.indexOf(null) + 1;
            const target = document.getElementById(`row-${firstEmpty}`);
            target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            target.classList.add('row-highlight');
            setTimeout(() => target.classList.remove('row-highlight'), 3000);
            return alert(`‚ö†Ô∏è Item No. ${firstEmpty} belum diperiksa!`);
        }

        btn.innerText = "SYNCING..."; btn.disabled = true;
        const payload = {
            nik: document.getElementById('asset').value,
            pic_name: document.getElementById('pic').value,
            check_date: document.getElementById('tgl').value,
            branch: document.getElementById('branch').value,
            items_data: values
        };

        const editingId = document.getElementById('editingId').value;
        let res = editingId ? await sbClient.from('toolbox_reports').update(payload).eq('id', editingId) : await sbClient.from('toolbox_reports').insert([payload]);

        if(res.error) alert(res.error.message);
        else { alert("‚úÖ Data Sync Berhasil!"); fetchHistory(); resetForm(); }
        btn.innerText = "‚òÅÔ∏è Sync Cloud"; btn.disabled = false;
    }

    async function fetchHistory() {
        document.getElementById('loader').classList.remove('hidden');
        let query = sbClient.from('toolbox_reports').select('*');
        if (userRole !== 'admin') query = query.eq('nik', userNrp);
        const { data } = await query.order('check_date', { ascending: false }).limit(10);
        
        document.getElementById('loader').classList.add('hidden');
        const histBody = document.getElementById('histBody');
        histBody.innerHTML = "";
        if(data) {
            data.forEach(row => {
                const b = row.items_data.filter(x => x==='B').length;
                const r = row.items_data.filter(x => x==='R').length;
                const h = row.items_data.filter(x => x==='H').length;
                histBody.innerHTML += `<tr class="border-b border-white/30 hover:bg-white/20 transition-all">
                    <td class="py-4 text-slate-600">${row.check_date}</td>
                    <td>${row.nik}</td>
                    <td class="uppercase">${row.pic_name}</td>
                    <td><span class="text-emerald-600">B:${b}</span> <span class="text-yellow-600">R:${r}</span> <span class="text-red-600">H:${h}</span></td>
                    <td class="text-right">
                        <button onclick='loadData(${JSON.stringify(row)})' class="bg-blue-600 text-white px-4 py-1.5 rounded-lg text-[9px] uppercase font-black">Edit</button>
                    </td>
                </tr>`;
            });
        }
    }

    function loadData(row) {
        document.getElementById('editingId').value = row.id;
        document.getElementById('asset').value = row.nik;
        document.getElementById('pic').value = row.pic_name;
        document.getElementById('tgl').value = row.check_date;
        row.items_data.forEach((val, i) => {
            const rad = document.querySelector(`input[name="t-${i+1}"][value="${val}"]`);
            if(rad) rad.checked = true;
        });
        refreshSummary(); updateMonthBadge();
        window.scrollTo({top: 0, behavior: 'smooth'});
    }

    function resetForm() {
        document.getElementById('editingId').value = "";
        document.getElementById('asset').value = userNrp;
        document.getElementById('pic').value = userName;
        document.getElementById('tgl').valueAsDate = new Date();
        document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
        refreshSummary(); updateMonthBadge();
    }

    // INIT
    document.getElementById('tgl').valueAsDate = new Date();
    document.getElementById('asset').value = userNrp;
    document.getElementById('pic').value = userName;
    updateMonthBadge();
    fetchHistory();
</script>
    <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')
        .then(reg => console.log('Glacier Service Worker: Active', reg))
        .catch(err => console.log('Glacier Service Worker: Failed', err));
    });
  }
</script>

</body>
</html>
