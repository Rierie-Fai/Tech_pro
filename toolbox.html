<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Toolbox Pro | NIK Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=JetBrains+Mono:wght@700&display=swap');
        
        :root {
            --base-width: 720px;
        }

        html { display: none; }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: linear-gradient(135deg, #2563eb 0%, #1e3a8a 50%, #0f172a 100%); 
            min-height: 100vh; margin: 0; padding: 0;
            overflow-x: hidden;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            color: #f1f5f9;
        }

        #snow-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }

        /* CONTAINER AUTO-SCALE */
        #scaler-context {
            width: var(--base-width);
            transform-origin: top center;
            transition: transform 0.2s ease-out;
            flex-shrink: 0;
            padding: 20px;
            position: relative;
            z-index: 10;
        }

        .glass-ice {
            background: rgba(255, 255, 255, 0.15); 
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.3); 
            box-shadow: 0 15px 35px 0 rgba(0, 0, 0, 0.2);
            border-radius: 2.5rem;
        }

        .input-glass {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1.25rem; padding: 12px; font-size: 14px; font-weight: 700;
            color: white; outline: none;
        }
        .input-glass:focus { border-color: #60a5fa; background: rgba(0, 0, 0, 0.4); }

        .scroll-area { max-height: 600px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.2) transparent; }

        th { 
            background: rgba(15, 23, 42, 0.9) !important; position: sticky; top: 0; z-index: 20;
            font-size: 10px; text-transform: uppercase; padding: 12px 8px; 
            color: #bfdbfe; border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        input[type="radio"] { width: 22px; height: 22px; cursor: pointer; accent-color: #3b82f6; opacity: 0.9; }

        .btn-action {
            font-weight: 800; padding: 1rem; border-radius: 1.5rem; text-transform: uppercase;
            font-size: 10px; letter-spacing: 0.1em; transition: 0.3s; box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        .btn-action:active { transform: scale(0.95); }
    </style>
</head>
<body>

<canvas id="snow-canvas"></canvas>

<div id="scaler-context" class="space-y-6">
    
    <header class="glass-ice p-5 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <button onclick="window.location.href='index.html'" class="h-10 w-10 bg-white/10 border border-white/20 rounded-xl flex items-center justify-center text-white transition-all shadow-sm hover:bg-white/20">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
            </button>
            <div>
                <h1 class="text-xl font-black text-white tracking-tighter uppercase italic leading-none">Toolbox <span class="text-blue-300">Pro</span></h1>
                <p id="roleText" class="text-[9px] text-blue-200 font-bold uppercase tracking-widest mt-1">NIK: LOADING...</p>
            </div>
        </div>
        <div id="currentMonthBadge" class="bg-blue-500 text-white px-5 py-2 rounded-xl font-black text-[10px] uppercase shadow-lg border border-white/10">FEB 2026</div>
    </header>

    <div class="grid grid-cols-3 gap-3">
        <div class="glass-ice p-4 text-center border-b-4 border-emerald-500 bg-emerald-500/10">
            <span class="block text-2xl font-black text-emerald-400" id="countB">0</span>
            <span class="text-[8px] font-bold text-blue-100 uppercase">Baik</span>
        </div>
        <div class="glass-ice p-4 text-center border-b-4 border-yellow-500 bg-yellow-500/10">
            <span class="block text-2xl font-black text-yellow-400" id="countR">0</span>
            <span class="text-[8px] font-bold text-blue-100 uppercase">Rusak</span>
        </div>
        <div class="glass-ice p-4 text-center border-b-4 border-red-500 bg-red-500/10">
            <span class="block text-2xl font-black text-red-400" id="countH">0</span>
            <span class="text-[8px] font-bold text-blue-100 uppercase">Hilang</span>
        </div>
    </div>

    <div class="glass-ice p-6 space-y-4">
        <input type="hidden" id="editingId">
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="text-[9px] font-black uppercase text-blue-200 mb-1 block ml-1">NIK Teknisi</label>
                <input type="text" id="asset" class="input-glass w-full font-mono text-blue-300" readonly>
            </div>
            <div>
                <label class="text-[9px] font-black uppercase text-blue-200 mb-1 block ml-1">Tanggal</label>
                <input type="date" id="tgl" onchange="updateMonthBadge()" class="input-glass w-full">
            </div>
        </div>
        <div>
            <label class="text-[9px] font-black uppercase text-blue-200 mb-1 block ml-1">Nama Lengkap</label>
            <input type="text" id="pic" class="input-glass w-full uppercase" readonly>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-3">
        <button onclick="prosesSimpan()" id="btnSubmit" class="btn-action bg-blue-500 text-white">‚òÅÔ∏è Sync NIK Cloud</button>
        <button onclick="checkAllBaik()" class="btn-action bg-emerald-600 text-white">‚úÖ Set All Baik</button>
        <button onclick="fetchHistory()" class="btn-action bg-white/10 text-white border border-white/20">üîÑ Pull History</button>
        <button onclick="resetForm()" class="btn-action bg-slate-900 text-white">‚ûï Reset Form</button>
    </div>

    <div class="glass-ice overflow-hidden">
        <div class="p-4 bg-white/10 border-b border-white/10 flex justify-between items-center">
            <span class="text-[10px] font-black uppercase italic text-blue-100">Inspection Checklist</span>
            <span class="text-[9px] font-bold text-blue-200 bg-white/10 px-2 py-0.5 rounded-full">106 Items</span>
        </div>
        <div class="scroll-area">
            <table class="w-full">
                <thead>
                    <tr>
                        <th width="50">No</th>
                        <th class="text-left">Item Name</th>
                        <th width="50">B</th>
                        <th width="50">R</th>
                        <th width="50">H</th>
                    </tr>
                </thead>
                <tbody id="toolTableBody" class="text-[11px] font-bold uppercase divide-y divide-white/10"></tbody>
            </table>
        </div>
    </div>

    <div class="glass-ice p-6">
        <h3 class="text-[10px] font-black uppercase italic tracking-widest text-blue-100 mb-4 flex items-center gap-2">
            <span class="w-1.5 h-4 bg-blue-400 rounded-full"></span> Recent NIK Logs
        </h3>
        <div class="overflow-x-auto">
            <table class="w-full text-[10px]">
                <tbody id="histBody" class="divide-y divide-white/5"></tbody>
            </table>
        </div>
        <div id="loader" class="hidden text-center py-4 font-black text-blue-300 italic animate-pulse text-[10px]">SYNCING DATABASE...</div>
    </div>

    <footer class="text-center pb-8">
        <p class="text-[8px] font-black text-blue-300/40 uppercase tracking-widest">¬© 2026 PT HEXINDO ADARO | SECURE NIK TERMINAL</p>
    </footer>
</div>

<script>
    // --- SNOW ENGINE ---
    const canvas = document.getElementById('snow-canvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    class Particle {
        constructor() { this.reset(); }
        reset() {
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height - canvas.height;
            this.size = Math.random() * 2 + 1;
            this.speed = Math.random() * 3 + 2;
            this.wind = Math.random() * 2 + 0.5;
            this.opacity = Math.random() * 0.6 + 0.2;
        }
        update() { this.y += this.speed; this.x += this.wind; if (this.y > canvas.height || this.x > canvas.width) this.reset(); }
        draw() { ctx.fillStyle = `rgba(255, 255, 255, ${this.opacity})`; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); }
    }
    function initSnow() { particles = []; for (let i = 0; i < 100; i++) particles.push(new Particle()); }
    function animateSnow() { ctx.clearRect(0, 0, canvas.width, canvas.height); particles.forEach(p => { p.update(); p.draw(); }); requestAnimationFrame(animateSnow); }

    // --- AUTO SCALE (720px) ---
    function runAutoScale() {
        const scaler = document.getElementById('scaler-context');
        const targetWidth = 720;
        const windowWidth = window.innerWidth;
        const scaleRatio = windowWidth / targetWidth;

        if (windowWidth < targetWidth) {
            scaler.style.transform = `scale(${scaleRatio})`;
            scaler.style.marginBottom = `-${(1 - scaleRatio) * scaler.offsetHeight}px`;
        } else {
            scaler.style.transform = `scale(1)`;
            scaler.style.marginBottom = `0px`;
        }
    }
    window.addEventListener('resize', () => { resizeCanvas(); runAutoScale(); });

    // --- SUPABASE & LOGIC ---
    const SB_URL = "https://corpgiuxyhfxdnqwwmlv.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNvcnBnaXV4eWhmeGRucXd3bWx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDMwNzcsImV4cCI6MjA4NTg3OTA3N30.PMp5yZOISYrBG0UUcIGaXUPnmEAaWVKgQ3Y1W8Nea_E";
    const sbClient = supabase.createClient(SB_URL, SB_KEY);

    const userNik = localStorage.getItem('userNIK') || localStorage.getItem('userNRP');
    const userName = localStorage.getItem('userName');
    const userRole = localStorage.getItem('userRole') || 'technician';

    const listAlat = ["Adjustable wrench L=12\"", "Adjustable wrench pipe L=10\"", "Allen key 12mm", "Allen key 14mm", "Allen key 17mm", "Allen key set 2-10mm", "Brush steel W=30mm", "Catridge belt wrench 125mm", "Chisel plate W=11 L=140mm", "Combination wrench 24mm", "Combination wrench 27mm", "Combination wrench 30mm", "Combination wrench 32mm", "Combination wrench 36mm", "Combination wrench 41mm", "Extention socket 1/2\" L=10\"", "Extention socket 1/2\" L=5\"", "Extention socket 3/4\" L=18\"", "Extention socket 3/4\" L=8\"", "Extention socket 1/2\" U-joint", "Feeler gauge set", "Files set (5 pcs) 150mm", "Files plate type 250mm", "Files round type 250mm", "Haksaw iron & blade", "Half moon wrench 14x17", "Half moon wrench 19x22", "Hammer besi 0.5kg", "Hammer karet 0.5kg", "Hammer plastik 0.5kg", "Handle socket T 1/2\"", "Handle socket T 3/4\"", "Handle rachet 1/2\"", "Handle rachet 3/4\"", "Magnetic stick L=50cm", "Multitester CD 800", "Open end 6x7", "Open end 8x9", "Open end 10x11", "Open end 12x13", "Open end 14x15", "Open end 16x17", "Open end 18x19", "Open end 20x22", "Open end 24x26", "Open end 36x41", "Paint brush", "Pliers combination 200mm", "Pliers side cutting 200mm", "Pliers water pump", "Pliers viece grip", "Pliers snap ring (in)", "Pliers snap ring (out)", "Pry bar L=40cm", "Punch drift 150mm", "Punch center 130mm", "Ring spanner 6x7", "Ring spanner 8x9", "Ring spanner 10x11", "Ring spanner 12x13", "Ring spanner 14x15", "Ring spanner 16x17", "Ring spanner 18x19", "Ring spanner 20x22", "Ring spanner 24x26", "Scale meter roll 2.5m", "Scrape blade W=25mm", "Screw drive plus 75mm", "Screw drive plus 100mm", "Screw drive plus 125mm", "Screw drive plus 150mm", "Screw drive plate 75mm", "Screw drive plate 100mm", "Screw drive plate 150mm", "Screw drive plate 200mm", "Socket (12) 1/2\" 10mm", "Socket (12) 1/2\" 11mm", "Socket (12) 1/2\" 12mm", "Socket (12) 1/2\" 13mm", "Socket (12) 1/2\" 14mm", "Socket (12) 1/2\" 15mm", "Socket (12) 1/2\" 16mm", "Socket (12) 1/2\" 17mm", "Socket (12) 1/2\" 18mm", "Socket (12) 1/2\" 19mm", "Socket (12) 1/2\" 20mm", "Socket (12) 1/2\" 21mm", "Socket (12) 1/2\" 22mm", "Socket (12) 3/4\" 22mm", "Socket (12) 3/4\" 23mm", "Socket (12) 3/4\" 24mm", "Socket (12) 3/4\" 27mm", "Socket (12) 3/4\" 28mm", "Socket (12) 3/4\" 29mm", "Socket (12) 3/4\" 30mm", "Socket (12) 3/4\" 32mm", "Socket (12) 3/4\" 36mm", "Socket (12) 3/4\" 38mm", "Socket (12) 3/4\" 41mm", "Socket (12) 3/4\" 46mm", "Stop watch digital", "Thermometer 0-200C", "Treeds gauge set", "Tools box 3 step", "Test pen DC", "Vernier caliper 150mm"];

    function initTable() {
        const tbody = document.getElementById('toolTableBody');
        tbody.innerHTML = listAlat.map((name, i) => `
            <tr class="hover:bg-white/5 transition-colors">
                <td class="text-center py-4 text-blue-300/50 font-mono text-[9px]">${i + 1}</td>
                <td class="pr-2 leading-tight text-white">${name}</td>
                <td class="text-center"><input type="radio" name="t-${i+1}" value="B" onclick="refreshSummary()"></td>
                <td class="text-center"><input type="radio" name="t-${i+1}" value="R" onclick="refreshSummary()"></td>
                <td class="text-center"><input type="radio" name="t-${i+1}" value="H" onclick="refreshSummary()"></td>
            </tr>
        `).join('');
    }

    function refreshSummary() {
        let b=0, r=0, h=0;
        listAlat.forEach((_, i) => {
            const rad = document.querySelector(`input[name="t-${i+1}"]:checked`);
            if(rad) { if(rad.value==='B') b++; else if(rad.value==='R') r++; else h++; }
        });
        document.getElementById('countB').innerText = b;
        document.getElementById('countR').innerText = r;
        document.getElementById('countH').innerText = h;
    }

    function checkAllBaik() {
        listAlat.forEach((_, i) => {
            const rb = document.querySelector(`input[name="t-${i+1}"][value="B"]`);
            if(rb) rb.checked = true;
        });
        refreshSummary();
    }

    function updateMonthBadge() {
        const t = document.getElementById('tgl').value; if(!t) return;
        const d = new Date(t);
        const m = ["JAN", "FEB", "MAR", "APR", "MEI", "JUN", "JUL", "AGU", "SEP", "OKT", "NOV", "DES"];
        document.getElementById('currentMonthBadge').innerText = m[d.getMonth()] + " " + d.getFullYear();
    }

    async function fetchHistory() {
        document.getElementById('loader').classList.remove('hidden');
        let q = sbClient.from('toolbox_reports').select('*');
        if (userRole !== 'admin') q = q.eq('nik', userNik);
        const { data } = await q.order('check_date', { ascending: false }).limit(5);
        document.getElementById('loader').classList.add('hidden');
        
        const hBody = document.getElementById('histBody');
        hBody.innerHTML = (data || []).map(row => {
            const b = row.items_data.filter(x => x==='B').length;
            const r = row.items_data.filter(x => x==='R').length;
            const h = row.items_data.filter(x => x==='H').length;
            return `
                <tr class="hover:bg-white/5 transition-all">
                    <td class="py-3">
                        <div class="font-black text-white">${row.check_date}</div>
                        <div class="text-[8px] text-blue-300 font-mono">${row.nik}</div>
                    </td>
                    <td class="py-3">
                        <div class="flex gap-2">
                            <span class="text-emerald-400">B:${b}</span>
                            <span class="text-yellow-400">R:${r}</span>
                            <span class="text-red-400">H:${h}</span>
                        </div>
                    </td>
                    <td class="text-right py-3">
                        <button onclick='loadData(${JSON.stringify(row)})' class="bg-blue-500 text-white px-3 py-1 rounded-lg text-[8px] font-black uppercase shadow-sm">Edit</button>
                    </td>
                </tr>`;
        }).join('');
    }

    async function prosesSimpan() {
        const vals = listAlat.map((_, i) => document.querySelector(`input[name="t-${i+1}"]:checked`)?.value || null);
        if(vals.includes(null)) return alert("‚ö†Ô∏è Perhatian: Ada item yang belum diperiksa!");
        
        const payload = {
            nik: document.getElementById('asset').value,
            pic_name: document.getElementById('pic').value,
            check_date: document.getElementById('tgl').value,
            branch: "ADARO PROJECT",
            items_data: vals
        };
        const id = document.getElementById('editingId').value;
        const res = id ? await sbClient.from('toolbox_reports').update(payload).eq('id', id) : await sbClient.from('toolbox_reports').insert([payload]);
        
        if(!res.error) { 
            alert("‚úÖ Sukses: Data NIK " + userNik + " Sinkron!"); 
            resetForm(); fetchHistory(); 
        } else {
            alert("‚ùå Gagal: " + res.error.message);
        }
    }

    function loadData(row) {
        document.getElementById('editingId').value = row.id;
        document.getElementById('tgl').value = row.check_date;
        row.items_data.forEach((val, i) => {
            const rad = document.querySelector(`input[name="t-${i+1}"][value="${val}"]`);
            if(rad) rad.checked = true;
        });
        refreshSummary(); updateMonthBadge(); window.scrollTo({top: 0, behavior: 'smooth'});
    }

    function resetForm() {
        document.getElementById('editingId').value = "";
        document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
        document.getElementById('tgl').valueAsDate = new Date();
        refreshSummary(); updateMonthBadge();
    }

    window.onload = () => {
        if (localStorage.getItem('isLoggedIn') !== 'true') window.location.href = 'login.html';
        resizeCanvas(); initSnow(); animateSnow();
        document.documentElement.style.display = 'block';
        document.getElementById('roleText').innerText = `NIK: ${userNik} | ${userName}`;
        document.getElementById('asset').value = userNik;
        document.getElementById('pic').value = userName;
        document.getElementById('tgl').valueAsDate = new Date();
        initTable(); fetchHistory();
        setTimeout(runAutoScale, 100);
    }
</script>
</body>
</html>