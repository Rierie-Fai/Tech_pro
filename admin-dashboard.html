<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Command Center | Glacier</title>
    
    <script>
        // Security Gate: Hanya Admin yang boleh masuk
        if (localStorage.getItem('isLoggedIn') !== 'true' || localStorage.getItem('userRole') !== 'admin') {
            window.location.replace('index.html');
        }
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=JetBrains+Mono:wght@700&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: linear-gradient(135deg, #d1e3ff 0%, #a2c2e8 100%);
            color: #1e293b; min-height: 100vh;
        }

        .glass-ice { 
            background: rgba(255, 255, 255, 0.4); 
            backdrop-filter: blur(25px) saturate(150%);
            -webkit-backdrop-filter: blur(25px) saturate(150%);
            border: 1px solid rgba(255, 255, 255, 0.6); 
            border-radius: 2rem;
            box-shadow: 0 10px 40px rgba(31, 38, 135, 0.08);
        }

        .stat-card-ice {
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 1.5rem;
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .stat-card-ice:hover { transform: translateY(-5px) scale(1.02); background: rgba(255, 255, 255, 0.8); }

        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(59, 130, 246, 0.2); border-radius: 10px; }

        .shard {
            position: absolute; background: white; pointer-events: none;
            clip-path: polygon(50% 0%, 100% 100%, 0% 100%);
            opacity: 0.8; animation: shatter 0.7s ease-out forwards; z-index: 100;
        }
        @keyframes shatter {
            0% { transform: translate(0, 0) rotate(0deg) scale(1); opacity: 1; }
            100% { transform: translate(var(--x), var(--y)) rotate(var(--r)) scale(0); opacity: 0; }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto space-y-6 relative">
        
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/30">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                </div>
                <div>
                    <h1 class="text-2xl font-black italic tracking-tighter uppercase text-slate-800">
                        Admin <span class="text-blue-600">Command Center</span>
                    </h1>
                    <p class="text-[10px] font-bold text-blue-500/70 tracking-[0.3em] uppercase">Arctic Monitoring System</p>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="location.reload(); iceShatter(event)" class="glass-ice p-3 hover:bg-white/60 transition-all text-slate-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                </button>
                <a href="index.html" onclick="iceShatter(event)" class="bg-blue-600 text-white px-6 py-3 rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-xl shadow-blue-500/20 hover:scale-105 transition-all">Portal Utama</a>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="stat-card-ice p-6">
                <p class="text-[9px] font-black text-blue-500 uppercase tracking-widest">UC Submissions</p>
                <h2 id="totalUC" class="text-4xl font-black mt-2 text-slate-800">0</h2>
            </div>
            <div class="stat-card-ice p-6">
                <p class="text-[9px] font-black text-emerald-600 uppercase tracking-widest">Activity Logs</p>
                <h2 id="totalAct" class="text-4xl font-black mt-2 text-slate-800">0</h2>
            </div>
            <div class="stat-card-ice p-6">
                <p class="text-[9px] font-black text-orange-500 uppercase tracking-widest">Toolbox Checks</p>
                <h2 id="totalTool" class="text-4xl font-black mt-2 text-slate-800">0</h2>
            </div>
            <div class="stat-card-ice p-6 border-blue-200">
                <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest">Tech Personnel</p>
                <h2 id="totalTech" class="text-4xl font-black mt-2 text-slate-800">0</h2>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 glass-ice p-8">
                <h3 class="text-xs font-black uppercase text-blue-600 mb-6 tracking-widest italic">Performance Trend</h3>
                <div class="h-[300px]">
                    <canvas id="prodChart"></canvas>
                </div>
            </div>

            <div class="glass-ice p-8">
                <h3 class="text-xs font-black uppercase text-blue-600 mb-6 tracking-widest italic">Live Feed</h3>
                <div id="liveFeed" class="space-y-4 h-[300px] overflow-y-auto custom-scroll pr-2 text-sm">
                    <p class="text-xs italic text-slate-400">Syncing Glacier Data...</p>
                </div>
            </div>
        </div>

        <div class="glass-ice p-8">
            <h3 class="text-xs font-black uppercase text-blue-600 mb-6 tracking-widest italic">Technician Leaderboard</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="text-slate-400 border-b border-black/5 uppercase text-[9px] font-black tracking-[0.2em]">
                            <th class="pb-4">Name</th>
                            <th class="pb-4">NIK</th>
                            <th class="pb-4">UC Count</th>
                            <th class="pb-4">Toolbox</th>
                            <th class="pb-4 text-right">Status</th>
                        </tr>
                    </thead>
                    <tbody id="rankingTable" class="text-slate-700 divide-y divide-black/5">
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // --- AUDIO & VISUAL ENGINE ---
        const playIceSound = () => {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(1200, ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(40, ctx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.1, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
            osc.connect(gain); gain.connect(ctx.destination);
            osc.start(); osc.stop(ctx.currentTime + 0.1);
        };

        const iceShatter = (e) => {
            playIceSound();
            for (let i = 0; i < 8; i++) {
                const shard = document.createElement('div');
                shard.className = 'shard';
                const size = Math.random() * 6 + 2;
                shard.style.width = size + 'px'; shard.style.height = size + 'px';
                shard.style.left = e.clientX + 'px'; shard.style.top = e.clientY + 'px';
                shard.style.setProperty('--x', (Math.random() - 0.5) * 150 + 'px');
                shard.style.setProperty('--y', (Math.random() - 0.5) * 150 + 'px');
                shard.style.setProperty('--r', Math.random() * 360 + 'deg');
                document.body.appendChild(shard);
                setTimeout(() => shard.remove(), 700);
            }
        };

        // --- DATABASE LOGIC ---
        const SB_URL = "https://corpgiuxyhfxdnqwwmlv.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNvcnBnaXV4eWhmeGRucXd3bWx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDMwNzcsImV4cCI6MjA4NTg3OTA3N30.PMp5yZOISYrBG0UUcIGaXUPnmEAaWVKgQ3Y1W8Nea_E";
        const sb = supabase.createClient(SB_URL, SB_KEY);

        async function initDashboard() {
            try {
                const { count: ucCount } = await sb.from('uc_reports').select('*', { count: 'exact', head: true });
                const { count: toolCount } = await sb.from('toolbox_reports').select('*', { count: 'exact', head: true });
                const { count: userCount } = await sb.from('users').select('*', { count: 'exact', head: true });
                
                document.getElementById('totalUC').innerText = ucCount || 0;
                document.getElementById('totalTool').innerText = toolCount || 0;
                document.getElementById('totalTech').innerText = userCount || 0;

                const { data: recentUC } = await sb.from('uc_reports').select('customer_name, unit_no, nik, inspection_date').order('id', {ascending: false}).limit(10);
                renderFeed(recentUC);

                const { data: allUsers } = await sb.from('users').select('nik, full_name');
                const { data: allUC } = await sb.from('uc_reports').select('nik');
                const { data: allTools } = await sb.from('toolbox_reports').select('nik');
                renderRanking(allUsers, allUC, allTools);

                renderChart();
            } catch (err) { console.error(err); }
        }

        function renderFeed(data) {
            const feed = document.getElementById('liveFeed');
            feed.innerHTML = data.map(item => `
                <div class="bg-white/40 p-3 rounded-xl border-l-4 border-blue-500 hover:bg-white/60 transition-all">
                    <p class="text-[10px] font-black text-blue-600 uppercase tracking-tighter">${item.unit_no} â€¢ ${item.customer_name}</p>
                    <p class="text-xs text-slate-700 mt-1 font-semibold">Inspection by <span class="text-blue-600">${item.nik}</span></p>
                    <p class="text-[9px] text-slate-400 mt-1 font-bold">${item.inspection_date}</p>
                </div>
            `).join('');
        }

        function renderRanking(users, ucData, toolData) {
            const tbody = document.getElementById('rankingTable');
            const ranking = users.map(user => ({
                name: user.full_name,
                nik: user.nik,
                uc: ucData.filter(u => u.nik === user.nik).length,
                tool: toolData.filter(t => t.nik === user.nik).length
            })).sort((a, b) => (b.uc + b.tool) - (a.uc + a.tool));

            tbody.innerHTML = ranking.map(r => `
                <tr class="hover:bg-white/30 transition-all">
                    <td class="py-4 font-bold uppercase italic text-slate-800">${r.name}</td>
                    <td class="font-mono text-blue-600 font-bold">${r.nik}</td>
                    <td class="font-black text-slate-600">${r.uc}</td>
                    <td class="font-black text-slate-600">${r.tool}</td>
                    <td class="text-right"><span class="px-2 py-1 rounded-full bg-emerald-100 text-emerald-600 text-[8px] font-black uppercase">Active</span></td>
                </tr>
            `).join('');
        }

        function renderChart() {
            const ctx = document.getElementById('prodChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Inspections',
                        data: [5, 12, 19, 14, 25, 30],
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#2563eb',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: 'rgba(0,0,0,0.03)' }, ticks: { color: '#64748b', font: { weight: 'bold' } } },
                        x: { grid: { display: false }, ticks: { color: '#64748b', font: { weight: 'bold' } } }
                    }
                }
            });
        }

        window.onload = initDashboard;
    </script>
</body>
</html>
