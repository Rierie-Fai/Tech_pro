<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Terminal Access | Hexindo Fleet</title>
    <link rel="manifest" href="../manifest.json">

    <script src="../js/tailwindcss.js"></script>
    <script src="../js/supabase-js@2.js"></script>
    
    <link href="../all.min.css" rel="stylesheet"> <link href="../css/rajdhani.css" rel="stylesheet">
    <link href="../css/jetbrain.css" rel="stylesheet">

    <style>
        /* --- WHITE MECHA PALETTE --- */
        :root {
            /* Backgrounds & Bases */
            --mecha-bg: #f0f4f8;            
            --mecha-white: #ffffff;         
            --mecha-glass: rgba(255, 255, 255, 0.85); 
            
            /* Accents & Borders */
            --accent-core: #2563eb;         /* Sapphire Blue */
            --accent-sec: #f59e0b;          /* Amber Orange */
            --metal-border: #cbd5e1;        
            
            /* Typography */
            --text-dark: #1e293b;           
            --text-muted: #64748b;          

            /* Animation Curves */
            --anim-mecha: cubic-bezier(0.23, 1, 0.32, 1);
        }

        body {
            background-color: var(--mecha-bg);
            background-image: 
                linear-gradient(rgba(37, 99, 235, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(37, 99, 235, 0.05) 1px, transparent 1px);
            background-size: 30px 30px;
            color: var(--text-dark);
            font-family: 'Rajdhani', sans-serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
        }

        /* --- BACKGROUND FX --- */
        #bg-canvas { position: fixed; inset: 0; z-index: 0; opacity: 0.4; pointer-events: none;}
        .scanlines {
            position: fixed; inset: 0; z-index: 50; pointer-events: none;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.02) 50%, rgba(0,0,0,0.02));
            background-size: 100% 4px;
        }

        /* --- DYNAMIC SCALER --- */
        #app-scaler {
            position: relative; z-index: 10;
            width: 440px;
            will-change: transform;
            transform-origin: center center;
        }

        /* --- WHITE MECHA CARD --- */
        .mecha-frame {
            background: var(--mecha-glass);
            backdrop-filter: blur(20px) saturate(120%);
            border: 2px solid var(--mecha-white);
            outline: 1px solid var(--metal-border);
            border-radius: 24px;
            padding: 40px;
            position: relative;
            box-shadow: 
                0 20px 40px -10px rgba(37, 99, 235, 0.15),
                0 0 20px rgba(255, 255, 255, 0.5) inset;
            overflow: hidden;
            /* Transition properties including border and shadow for pulse effect */
            transition: height 0.4s var(--anim-mecha), box-shadow 0.3s ease, border-color 0.3s ease;
        }

        /* PULSE ANIMATION KEYFRAMES */
        @keyframes mech-pulse {
            0% {
                border-color: var(--mecha-white);
                box-shadow: 0 20px 40px -10px rgba(37, 99, 235, 0.15);
            }
            50% {
                border-color: var(--accent-core);
                box-shadow: 
                    0 0 15px 2px rgba(37, 99, 235, 0.4),
                    0 30px 60px -5px rgba(37, 99, 235, 0.3),
                    0 0 40px rgba(37, 99, 235, 0.1) inset;
            }
            100% {
                border-color: var(--mecha-white);
                box-shadow: 0 20px 40px -10px rgba(37, 99, 235, 0.15);
            }
        }

        .mecha-frame.pulsing {
            animation: mech-pulse 0.8s ease-in-out forwards;
        }

        /* Decorative Corners */
        .corner-deco { position: absolute; width: 20px; height: 20px; border: 3px solid var(--accent-core); opacity: 0.8; transition: 0.3s; z-index: 20;}
        .c-tl { top: -2px; left: -2px; border-right: 0; border-bottom: 0; border-radius: 22px 0 0 0; }
        .c-br { bottom: -2px; right: -2px; border-left: 0; border-top: 0; border-radius: 0 0 22px 0; }
        
        /* --- FORM SLIDER MECHANISM --- */
        .form-slider {
            position: relative;
            width: 100%;
            min-height: 340px; /* Menjaga tinggi agar tidak collapse */
        }

        .auth-panel {
            position: absolute;
            top: 0; left: 0; width: 100%;
            transition: all 0.6s var(--anim-mecha);
            opacity: 0;
            pointer-events: none;
            visibility: hidden;
            transform: scale(0.95);
        }

        .auth-panel.active {
            position: relative;
            opacity: 1;
            transform: translateX(0) scale(1);
            pointer-events: auto;
            visibility: visible;
        }

        .auth-panel.prev { transform: translateX(-80px) scale(0.95); opacity: 0; }
        .auth-panel.next { transform: translateX(80px) scale(0.95); opacity: 0; }

        /* --- INPUTS & BUTTONS --- */
        .input-group { position: relative; margin-bottom: 20px; }
        
        .mech-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid var(--metal-border);
            color: var(--text-dark);
            padding: 16px 16px 16px 50px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            font-weight: 700;
            border-radius: 12px;
            outline: none;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }
        .mech-input:focus {
            border-color: var(--accent-core);
            background: var(--mecha-white);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }
        .mech-icon {
            position: absolute; left: 18px; top: 50%; transform: translateY(-50%);
            color: #94a3b8; transition: 0.3s; font-size: 18px;
        }
        .mech-input:focus ~ .mech-icon { color: var(--accent-core); }

        .btn-core {
            width: 100%;
            color: white;
            font-weight: 800;
            padding: 18px;
            border-radius: 12px;
            font-size: 16px;
            letter-spacing: 2px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: linear-gradient(135deg, var(--accent-core), #1d4ed8);
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
        }
        .btn-core.secondary {
            background: linear-gradient(135deg, var(--accent-sec), #d97706);
            box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.2);
        }
        .btn-core:hover { transform: translateY(-2px); box-shadow: 0 12px 20px -5px rgba(37, 99, 235, 0.3); }
        .btn-core:active { transform: scale(0.98); }
        
        /* Spinner */
        .spinner { display: inline-block; width: 16px; height: 16px; border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 10px; vertical-align: middle;}
        @keyframes spin { to {transform: rotate(360deg);} }

        /* Console Log */
        .console-log {
            margin-top: 24px;
            padding: 14px;
            background: rgba(241, 245, 249, 0.8);
            border: 1px solid var(--metal-border);
            border-left: 4px solid var(--accent-core);
            border-radius: 8px;
            font-family: 'JetBrains Mono';
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            min-height: 46px;
            display: flex; align-items: center;
        }
        .blink { animation: blink 1s infinite; font-weight: 900; color: var(--accent-core);}
        @keyframes blink { 50% { opacity: 0; } }

        /* Utilities */
        .header-shadow { text-shadow: 2px 2px 0px rgba(255,255,255,1), 4px 4px 10px rgba(37, 99, 235, 0.2); }
        .text-accent { color: var(--accent-core); }
        .text-accent-sec { color: var(--accent-sec); }
        
        /* Error Shake Animation */
        @keyframes shake { 0%,100%{transform:translate(0)} 20%{transform:translate(-8px)} 40%{transform:translate(8px)} 60%{transform:translate(-4px)} 80%{transform:translate(4px)} }

    </style>
</head>
<body>

    <div class="scanlines"></div>
    <canvas id="bg-canvas"></canvas>

    <div id="app-scaler">
        
        <div class="text-center mb-10 relative z-10">
            <div class="inline-block">
                 <h1 class="text-6xl font-black italic tracking-tighter text-dark header-shadow">
                    HEXINDO
                </h1>
                <span class="block text-xl text-accent tracking-[0.6em] font-bold not-italic mt-1 border-b-2 border-blue-200 pb-2 inline-block bg-white/50 px-4 rounded-full">
                    FLEET SYS
                </span>
            </div>
        </div>

        <div class="mecha-frame" id="mainCard">
            <div class="corner-deco c-tl"></div>
            <div class="corner-deco c-br"></div>

            <div class="form-slider">
                
                <div id="panelLogin" class="auth-panel active">
                    <h2 class="text-2xl font-black mb-8 text-dark flex items-center gap-3 uppercase italic tracking-tight">
                        <span class="bg-blue-100 p-2 rounded-lg"><i class="fas fa-shield-halved text-accent"></i></span> TERMINAL ACCESS
                    </h2>
                    
                    <form onsubmit="App.handleLogin(event)">
                        <div class="input-group">
                            <input type="text" id="loginNik" class="mech-input" placeholder="ID NIK" required autocomplete="off">
                            <i class="fas fa-id-badge mech-icon"></i>
                        </div>
                        <div class="input-group">
                            <input type="password" id="loginPass" class="mech-input" placeholder="ACCESS CODE" required>
                            <i class="fas fa-key mech-icon"></i>
                        </div>
                        
                        <button type="submit" class="btn-core" id="btnLogin">
                            <span class="btn-txt">ENGAGE SYSTEM</span> <i class="fas fa-chevron-right ml-2 text-sm"></i>
                        </button>
                    </form>

                    <div class="mt-8 text-center">
                        <p class="text-[11px] text-muted font-bold font-mono mb-3 tracking-widest">NEW UNIT DEPLOYMENT?</p>
                        <button onclick="App.switchPanel('register')" class="text-xs font-black text-muted hover:text-blue-600 tracking-[0.2em] uppercase transition-all border-b-2 border-dashed border-slate-300 pb-1">
                            REQUEST IDENTITY
                        </button>
                    </div>
                </div>

                <div id="panelRegister" class="auth-panel next">
                     <h2 class="text-2xl font-black mb-8 text-dark flex items-center gap-3 uppercase italic tracking-tight">
                        <span class="bg-amber-100 p-2 rounded-lg"><i class="fas fa-user-plus text-accent-sec"></i></span> NEW REGISTRATION
                    </h2>
                    
                    <form onsubmit="App.handleRegister(event)">
                        <div class="input-group">
                            <input type="text" id="regNik" class="mech-input" placeholder="NIK (UNIQUE ID)" required autocomplete="off">
                            <i class="fas fa-id-card mech-icon"></i>
                        </div>
                        <div class="input-group">
                            <input type="text" id="regName" class="mech-input" placeholder="FULL UNIT NAME" required autocomplete="off">
                            <i class="fas fa-user-astronaut mech-icon"></i>
                        </div>
                        <div class="input-group">
                            <input type="password" id="regPass" class="mech-input" placeholder="CREATE ACCESS CODE" required>
                            <i class="fas fa-lock mech-icon"></i>
                        </div>
                        
                        <button type="submit" class="btn-core secondary" id="btnReg">
                            <span class="btn-txt">SUBMIT REQUEST</span> <i class="fas fa-upload ml-2 text-sm"></i>
                        </button>
                    </form>

                    <div class="mt-8 text-center">
                        <p class="text-[11px] text-muted font-bold font-mono mb-3 tracking-widest">ALREADY OPERATIONAL?</p>
                        <button onclick="App.switchPanel('login')" class="text-xs font-black text-muted hover:text-amber-600 tracking-[0.2em] uppercase transition-all border-b-2 border-dashed border-slate-300 pb-1">
                            RETURN TO LOGIN
                        </button>
                    </div>
                </div>

            </div>

            <div class="console-log">
                <span class="text-accent mr-2 font-black">></span>
                <span id="sysMsg">SYSTEM READY. AWAITING CREDENTIALS.</span>
                <span class="blink ml-1">_</span>
            </div>

        </div>

        <div class="text-center mt-6 opacity-50">
            <p class="text-[10px] font-mono text-muted font-bold uppercase tracking-widest">SECURE CONNECTION // HEX-NET WHITE OPS v5.0</p>
        </div>
    </div>

    <script>
        const CONFIG = {
            SB_URL: "https://corpgiuxyhfxdnqwwmlv.supabase.co",
            SB_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNvcnBnaXV4eWhmeGRucXd3bWx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDMwNzcsImV4cCI6MjA4NTg3OTA3N30.PMp5yZOISYrBG0UUcIGaXUPnmEAaWVKgQ3Y1W8Nea_E"
        };

        const App = {
            sb: supabase.createClient(CONFIG.SB_URL, CONFIG.SB_KEY),
            
            init() {
                this.initScaler();
                this.initParticles();
                localStorage.removeItem('isLoggedIn');
            },

            // --- SCALER ---
            initScaler() {
                const scaler = document.getElementById('app-scaler');
                const baseW = 460;
                const baseH = 850; 
                const resize = () => {
                    const winW = window.innerWidth;
                    const winH = window.innerHeight;
                    let scale = Math.min(winW / baseW, winH / baseH);
                    if (scale > 1.1) scale = 1.1;
                    scaler.style.transform = `scale(${scale})`;
                };
                window.addEventListener('resize', resize);
                resize();
            },

            // --- TRANSITION LOGIC (PULSE & SLIDE) ---
            switchPanel(target) {
                const pLogin = document.getElementById('panelLogin');
                const pReg = document.getElementById('panelRegister');
                const card = document.getElementById('mainCard');

                this.log(`INITIALIZING ${target.toUpperCase()} PROTOCOL...`, "neutral");

                // Trigger Pulse
                card.classList.remove('pulsing');
                void card.offsetWidth; // Force Reflow
                card.classList.add('pulsing');
                setTimeout(() => card.classList.remove('pulsing'), 800);

                // Slide Logic
                if (target === 'register') {
                    pLogin.classList.remove('active');
                    pLogin.classList.add('prev');
                    
                    pReg.classList.remove('prev', 'next');
                    pReg.classList.add('active');
                } else {
                    pReg.classList.remove('active');
                    pReg.classList.add('next');
                    
                    pLogin.classList.remove('prev', 'next');
                    pLogin.classList.add('active');
                }
            },

            // --- LOGIN ---
            async handleLogin(e) {
                e.preventDefault();
                const btn = document.getElementById('btnLogin');
                const nik = document.getElementById('loginNik').value.toUpperCase().trim();
                const pass = document.getElementById('loginPass').value.trim();

                this.setLoading(btn, true);
                this.log("VERIFYING CREDENTIALS...", "neutral");

                try {
                    await new Promise(r => setTimeout(r, 1200));

                    const { data, error } = await this.sb.from('users').select('*').eq('nik', nik).single();
                    
                    if (error || !data || data.password !== pass) throw new Error("INVALID NIK OR PASSWORD");
                    if (data.status === 'pending') throw new Error("ACCOUNT PENDING APPROVAL");

                    this.log("AUTHENTICATION SUCCESS. ENGAGING...", "success");
                    localStorage.setItem('isLoggedIn', 'true');
                    localStorage.setItem('userNIK', data.nik);
                    
                    // Exit Animation
                    document.body.style.transition = "all 0.8s ease-out";
                    document.body.style.backgroundColor = "#ffffff";
                    document.getElementById('app-scaler').style.opacity = "0";
                    document.getElementById('app-scaler').style.transform += " scale(1.1)";

                    setTimeout(() => window.location.replace('../index/index-mecha.html'), 800);

                } catch (err) {
                    this.log("ERROR: " + err.message, "error");
                    this.shakeCard();
                    this.setLoading(btn, false, `ENGAGE SYSTEM <i class="fas fa-chevron-right ml-2 text-sm"></i>`);
                }
            },

            // --- REGISTER ---
            async handleRegister(e) {
                e.preventDefault();
                const btn = document.getElementById('btnReg');
                const nik = document.getElementById('regNik').value.toUpperCase().trim();
                const name = document.getElementById('regName').value.toUpperCase().trim();
                const pass = document.getElementById('regPass').value.trim();

                this.setLoading(btn, true);
                this.log("UPLOADING NEW UNIT DATA...", "neutral");

                try {
                    await new Promise(r => setTimeout(r, 1500));

                    const { data: exist } = await this.sb.from('users').select('nik').eq('nik', nik).single();
                    if (exist) throw new Error("NIK ALREADY REGISTERED");

                    const { error } = await this.sb.from('users').insert([{
                        nik, full_name: name, password: pass, role: 'technician', status: 'pending'
                    }]);

                    if (error) throw error;

                    this.log("SUCCESS: REQUEST LOGGED. AWAITING APPROVAL.", "success");
                    alert("Registration Transmitted!\nPlease wait for admin approval.");
                    
                    e.target.reset();
                    this.switchPanel('login');
                    this.setLoading(btn, false, `SUBMIT REQUEST <i class="fas fa-upload ml-2 text-sm"></i>`);

                } catch (err) {
                    this.log("UPLOAD FAILED: " + err.message, "error");
                    this.shakeCard();
                    this.setLoading(btn, false, `SUBMIT REQUEST <i class="fas fa-upload ml-2 text-sm"></i>`);
                }
            },

            // --- UTILITIES ---
            log(text, type) {
                const el = document.getElementById('sysMsg');
                el.innerText = text;
                el.className = ''; 
                if(type === 'error') el.classList.add('text-red-600', 'font-bold');
                else if(type === 'success') el.classList.add('text-blue-600', 'font-bold');
                else el.classList.add('text-slate-500');
            },

            setLoading(btn, isLoading, originalContent = "") {
                if(isLoading) {
                    btn.disabled = true;
                    btn.innerHTML = `<span class="spinner"></span> PROCESSING`;
                } else {
                    btn.disabled = false;
                    btn.innerHTML = originalContent;
                }
            },

            shakeCard() {
                const c = document.getElementById('mainCard');
                c.style.borderColor = "#ef4444"; 
                c.style.animation = "shake 0.4s ease-in-out";
                setTimeout(() => {
                    c.style.animation = "";
                    c.style.borderColor = "var(--mecha-white)"; 
                }, 400);
            },

            // --- PARTICLES (Blue Square Energy) ---
            initParticles() {
                const canvas = document.getElementById('bg-canvas');
                const ctx = canvas.getContext('2d');
                
                const resizeP = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
                window.addEventListener('resize', resizeP);
                resizeP();

                let particles = Array.from({length: 40}, () => ({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    vx: (Math.random() - 0.5) * 0.4,
                    vy: (Math.random() - 0.5) * 0.4,
                    size: Math.random() * 4 + 1,
                    a: Math.random() * 0.3
                }));

                const loop = () => {
                    ctx.clearRect(0,0, canvas.width, canvas.height);
                    ctx.fillStyle = "#2563eb"; // Blue
                    
                    particles.forEach(p => {
                        p.x += p.vx; p.y += p.vy;
                        if(p.x < 0 || p.x > canvas.width) p.vx *= -1;
                        if(p.y < 0 || p.y > canvas.height) p.vy *= -1;
                        
                        ctx.globalAlpha = p.a;
                        ctx.beginPath();
                        ctx.rect(p.x, p.y, p.size, p.size); // Tech squares
                        ctx.fill();
                    });
                    requestAnimationFrame(loop);
                };
                loop();
            }
        };

        window.onload = () => App.init();
    </script>
    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('../sw.js')
                .then(reg => console.log('Terminal Synced:', reg.scope))
                .catch(err => console.log('Sync Failed:', err));
        });
    }
</script>

</body>
</html>
