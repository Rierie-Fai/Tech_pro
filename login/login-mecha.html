<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Terminal Access | Hexindo Fleet</title>
    <link rel="manifest" href="../manifest.json">
    <meta name="theme-color" content="#f1f5f9">

    <script src="../js/tailwindcss.js"></script>
    <script src="../js/supabase-js@2.js"></script>
    <link href="../css/all.min.css" rel="stylesheet">
    <link href="../css/rajdhani.css" rel="stylesheet">
    <link href="../css/jetbrain.css" rel="stylesheet">

    <style>
        :root {
            --base-width: 400px;
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.8);
            --accent-color: #f59e0b;
            --text-primary: #0f172a;
        }

        body { 
            font-family: 'Rajdhani', sans-serif; 
            background-color: #f1f5f9;
            background-image: 
                linear-gradient(0deg, #cbd5e1 1px, transparent 1px), 
                linear-gradient(90deg, #cbd5e1 1px, transparent 1px);
            background-size: 40px 40px;
            min-height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden;
            color: var(--text-primary);
        }

        #mecha-canvas { position: fixed; inset: 0; pointer-events: none; z-index: 0; opacity: 0.6; }

        #scaler-context { width: var(--base-width); position: relative; z-index: 10; padding: 2rem; }

        .glass-mecha { 
            background: var(--glass-bg); backdrop-filter: blur(12px) saturate(120%); 
            border: 2px solid white; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
            border-radius: 32px; padding: 3rem 2.5rem; position: relative; overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Input Styles */
        .input-group { position: relative; margin-bottom: 1.2rem; }
        .input-mecha { 
            width: 100%; padding: 14px 16px 14px 50px; 
            background: rgba(255, 255, 255, 0.6); border: 2px solid #e2e8f0; border-radius: 16px;
            font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 700; color: #334155;
            outline: none; transition: all 0.3s;
        }
        .input-mecha:focus { 
            background: white; border-color: var(--accent-color); 
            box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.1); 
        }
        .input-icon { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #94a3b8; transition: 0.3s; }
        .input-mecha:focus ~ .input-icon { color: var(--accent-color); }

        /* Button Mecha */
        .btn-mecha {
            width: 100%; padding: 16px; border-radius: 16px;
            background: #1e293b; color: white;
            font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 16px; letter-spacing: 0.1em;
            text-transform: uppercase; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); margin-top: 1.5rem;
        }
        .btn-mecha:active { transform: scale(0.96); }
        .btn-mecha:disabled { opacity: 0.7; cursor: not-allowed; }

        /* Switch Mode Link */
        .switch-mode {
            text-align: center; margin-top: 1.5rem; font-size: 11px; font-weight: 700; 
            text-transform: uppercase; letter-spacing: 0.1em; color: #64748b; cursor: pointer;
        }
        .switch-mode span { color: var(--accent-color); text-decoration: underline; }

        /* Animations */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .shake-active { animation: shake 0.3s ease-in-out; border-color: #ef4444; }
        
        .hidden-field { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .spinner { width: 20px; height: 20px; border: 2px solid white; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    
    <canvas id="mecha-canvas"></canvas>

    <div id="scaler-context">
        <div class="glass-mecha" id="loginCard">
            <div class="flex flex-col items-center mb-8">
                <div class="w-16 h-16 bg-white rounded-2xl border-2 border-slate-100 shadow-sm mb-5 flex items-center justify-center text-3xl text-slate-700 relative overflow-hidden">
                    <i class="fas fa-shield-halved text-amber-500 relative z-10"></i>
                </div>
                <h1 class="text-3xl font-black text-slate-800 tracking-tighter uppercase italic leading-none">HEXINDO <span class="text-amber-500">FLEET</span></h1>
                <p id="pageTitle" class="text-[10px] font-bold text-slate-400 tracking-[0.3em] uppercase mt-2 font-mono">SECURE TERMINAL ACCESS</p>
            </div>

            <form id="authForm">
                <div class="input-group">
                    <input type="text" id="nikInput" class="input-mecha uppercase" placeholder="NIK IDENTITY" autocomplete="off" required>
                    <i class="fas fa-id-card input-icon"></i>
                </div>

                <div class="input-group hidden-field" id="nameGroup">
                    <input type="text" id="nameInput" class="input-mecha uppercase" placeholder="FULL NAME">
                    <i class="fas fa-user input-icon"></i>
                </div>

                <div class="input-group">
                    <input type="password" id="passInput" class="input-mecha" placeholder="ACCESS KEY" required>
                    <i class="fas fa-fingerprint input-icon"></i>
                </div>
                
                <button type="submit" id="btnSubmit" class="btn-mecha hover:bg-slate-700 hover:shadow-lg">
                    <span id="btnText">INITIALIZE SESSION</span>
                    <i class="fas fa-arrow-right"></i>
                </button>
            </form>

            <div class="switch-mode" onclick="App.toggleMode()">
                <p id="switchText">New Personnel? <span>Register Access</span></p>
            </div>

            <div class="mt-6 text-center">
                <p id="statusMsg" class="text-[10px] text-slate-400 font-mono font-bold uppercase tracking-widest">/// SYSTEM_READY</p>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const CONFIG = {
            SB_URL: "https://corpgiuxyhfxdnqwwmlv.supabase.co",
            SB_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNvcnBnaXV4eWhmeGRucXd3bWx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDMwNzcsImV4cCI6MjA4NTg3OTA3N30.PMp5yZOISYrBG0UUcIGaXUPnmEAaWVKgQ3Y1W8Nea_E"
        };

        // --- AUDIO ENGINE ---
        const AudioFX = {
            ctx: null,
            play(type) {
                if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                const t = this.ctx.currentTime;
                
                if (type === 'click') {
                    osc.frequency.setValueAtTime(600, t); osc.frequency.exponentialRampToValueAtTime(300, t + 0.1);
                    gain.gain.setValueAtTime(0.05, t); gain.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
                    osc.start(t); osc.stop(t + 0.1);
                } else if (type === 'error') {
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, t);
                    gain.gain.setValueAtTime(0.1, t); gain.gain.linearRampToValueAtTime(0, t + 0.2);
                    osc.start(t); osc.stop(t + 0.2);
                }
            }
        };

        // --- PARTICLE ENGINE ---
        const canvas = document.getElementById('mecha-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        class P {
            constructor() { this.reset(); }
            reset() { this.x = Math.random()*canvas.width; this.y = Math.random()*canvas.height; this.size = Math.random()*2+1; this.v = Math.random()*0.5; this.o = Math.random()*0.3; }
            update() { this.y += this.v; if(this.y > canvas.height) this.reset(); }
            draw() { ctx.fillStyle = `rgba(148, 163, 184, ${this.o})`; ctx.beginPath(); ctx.rect(this.x, this.y, this.size, this.size); ctx.fill(); }
        }
        function initP() { particles = []; for(let i=0; i<80; i++) particles.push(new P()); }
        function anim() { ctx.clearRect(0,0,canvas.width,canvas.height); particles.forEach(p=>{p.update();p.draw();}); requestAnimationFrame(anim); }

        // --- APP LOGIC (ES8) ---
        const App = {
            sb: supabase.createClient(CONFIG.SB_URL, CONFIG.SB_KEY),
            isRegisterMode: false,
            
            init() {
                resize(); initP(); anim();
                window.addEventListener('resize', resize);
                
                // Clear session on load to ensure clean slate
                localStorage.clear();
                
                document.getElementById('authForm').onsubmit = (e) => this.handleSubmit(e);
            },

            toggleMode() {
                this.isRegisterMode = !this.isRegisterMode;
                const nameGroup = document.getElementById('nameGroup');
                const btnText = document.getElementById('btnText');
                const switchText = document.getElementById('switchText');
                const title = document.getElementById('pageTitle');
                
                if (this.isRegisterMode) {
                    nameGroup.classList.remove('hidden-field');
                    nameGroup.classList.add('fade-in');
                    document.getElementById('nameInput').required = true;
                    btnText.innerText = "SEND ACCESS REQUEST";
                    switchText.innerHTML = "Have an account? <span>Login Here</span>";
                    title.innerText = "NEW MEMBER REGISTRATION";
                } else {
                    nameGroup.classList.add('hidden-field');
                    document.getElementById('nameInput').required = false;
                    btnText.innerText = "INITIALIZE SESSION";
                    switchText.innerHTML = "New Personnel? <span>Register Access</span>";
                    title.innerText = "SECURE TERMINAL ACCESS";
                }
                AudioFX.play('click');
            },

            async handleSubmit(e) {
                e.preventDefault();
                AudioFX.play('click');
                
                const nik = document.getElementById('nikInput').value.toUpperCase().trim();
                const pass = document.getElementById('passInput').value.trim();
                const btn = document.getElementById('btnSubmit');
                const status = document.getElementById('statusMsg');
                
                btn.disabled = true;
                btn.innerHTML = `<div class="spinner"></div> PROCESSING`;

                try {
                    await new Promise(r => setTimeout(r, 800)); // UI Delay

                    if (this.isRegisterMode) {
                        // --- REGISTRATION LOGIC ---
                        const name = document.getElementById('nameInput').value.toUpperCase().trim();
                        
                        // 1. Cek duplikasi NIK
                        const { data: existing } = await this.sb.from('users').select('nik').eq('nik', nik).single();
                        if (existing) throw new Error("NIK_EXISTS");

                        // 2. Insert User (Status: PENDING)
                        const { error: userError } = await this.sb.from('users').insert([{
                            nik: nik,
                            full_name: name,
                            password: pass,
                            role: 'technician',
                            status: 'pending' // Kunci agar Admin bisa Approve/Reject
                        }]);
                        if (userError) throw userError;

                        // 3. Insert Log Notifikasi (Agar muncul di Admin Drawer)
                        await this.sb.from('activity_logs').insert([{
                            nik: nik,
                            activity: "REGISTRATION_REQUEST",
                            details: `New Member Request: ${name}`
                        }]);

                        status.innerHTML = `/// REQUEST SENT: <span class="text-blue-500">AWAITING ADMIN</span>`;
                        alert("âœ… Registration Successful!\n\nYour request has been sent to the Administrator.\nPlease wait for approval before logging in.");
                        this.toggleMode(); // Kembali ke mode login

                    } else {
                        // --- LOGIN LOGIC ---
                        const { data, error } = await this.sb.from('users').select('*').eq('nik', nik).single();

                        if (error || !data || data.password !== pass) throw new Error("INVALID_CREDENTIALS");
                        
                        // GUARD: Cek Status Akun
                        if (data.status === 'pending') throw new Error("ACCOUNT_PENDING");
                        if (data.status === 'suspended') throw new Error("ACCOUNT_SUSPENDED");

                        // SUKSES
                        status.innerHTML = `/// AUTH_SUCCESS: <span class="text-emerald-500">${data.role.toUpperCase()}</span>`;
                        localStorage.setItem('isLoggedIn', 'true');
                        localStorage.setItem('userNIK', data.nik);
                        localStorage.setItem('userName', data.full_name);
                        
                        setTimeout(() => window.location.replace('../index/index-mecha.html'), 500);
                        return;
                    }

                } catch (err) {
                    AudioFX.play('error');
                    console.error(err);
                    document.getElementById('loginCard').classList.add('shake-active');
                    setTimeout(() => document.getElementById('loginCard').classList.remove('shake-active'), 300);

                    let msg = "ACCESS DENIED";
                    if (err.message === "ACCOUNT_PENDING") msg = "WAITING FOR ADMIN APPROVAL";
                    else if (err.message === "ACCOUNT_SUSPENDED") msg = "ACCOUNT SUSPENDED";
                    else if (err.message === "NIK_EXISTS") msg = "NIK ALREADY REGISTERED";
                    else if (err.message === "INVALID_CREDENTIALS") msg = "INVALID NIK OR PASSWORD";
                    
                    status.innerHTML = `/// ERROR: <span class="text-red-500">${msg}</span>`;
                }

                btn.disabled = false;
                btn.innerHTML = `<span>${this.isRegisterMode ? 'SEND REQUEST' : 'INITIALIZE SESSION'}</span><i class="fas fa-arrow-right"></i>`;
            }
        };

        window.onload = () => App.init();
    </script>
    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('../sw.js')
                .then(reg => console.log('Terminal Synced:', reg.scope))
                .catch(err => console.log('Sync Failed:', err));
        });
    }
    </script>

</body>
</html>
