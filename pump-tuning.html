<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pump Tune-Up | Mecha White</title>
    
    <script>
        if (localStorage.getItem('isLoggedIn') !== 'true') { window.location.replace('../login.html'); }
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --base-width: 720px;
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 1);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --accent-color: #2563eb;
        }

        body { 
            font-family: 'Rajdhani', sans-serif; 
            background-color: #f1f5f9;
            background-image: 
                radial-gradient(at 0% 0%, hsla(210,100%,96%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(210,100%,93%,1) 0, transparent 50%), 
                linear-gradient(0deg, #e2e8f0 1px, transparent 1px), 
                linear-gradient(90deg, #e2e8f0 1px, transparent 1px);
            background-size: 100% 100%, 100% 100%, 40px 40px, 40px 40px;
            min-height: 100vh; 
            color: var(--text-primary);
            margin: 0; padding: 0;
            overflow-x: hidden;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        #mecha-canvas { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            pointer-events: none; z-index: 1; opacity: 0.6;
        }

        #scaler-context {
            width: var(--base-width);
            transform-origin: top center;
            transition: transform 0.2s ease-out;
            flex-shrink: 0;
            padding: 1.5rem;
            position: relative;
            z-index: 10;
        }

        /* --- Mecha Components --- */
        .glass-mecha { 
            background: var(--glass-bg); 
            backdrop-filter: blur(20px) saturate(120%); 
            border: 1px solid var(--glass-border); 
            box-shadow: var(--glass-shadow);
            border-radius: 16px;
            position: relative;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .glass-mecha::before {
            content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%;
            background: linear-gradient(180deg, var(--accent-color), transparent); opacity: 0.5;
        }

        .header-label { 
            font-family: 'JetBrains Mono', monospace; font-size: 10px; font-weight: 700; 
            color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.1em; 
            display: block; margin-bottom: 6px; 
        }

        .input-mecha { 
            border: 1px solid #cbd5e1; border-radius: 8px; font-weight: 600; width: 100%; 
            padding: 10px 14px; background: rgba(255, 255, 255, 0.6); font-size: 14px; 
            outline: none; transition: 0.3s; color: var(--text-primary); 
            font-family: 'Rajdhani', sans-serif;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        }

        .input-mecha:focus { 
            border-color: var(--accent-color); background: #ffffff; 
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); 
        }

        .input-readonly { 
            background: #e2e8f0 !important; color: #94a3b8 !important; border-style: dashed; 
        }

        /* --- Buttons --- */
        .btn-mecha {
            position: relative; overflow: hidden; transition: all 0.3s; transform: skew(-10deg);
            display: inline-flex; align-items: center; justify-content: center;
        }
        .btn-mecha span, .btn-mecha i { transform: skew(10deg); }
        .btn-mecha:active { transform: skew(-10deg) scale(0.95); }

        .tab-btn {
            background: transparent; border: 1px solid transparent; color: var(--text-secondary);
            font-weight: 700; text-transform: uppercase; font-size: 11px; padding: 8px 16px;
            border-radius: 6px; transition: all 0.3s; font-family: 'Rajdhani', sans-serif;
        }
        .tab-btn.active {
            background: #eff6ff; color: var(--accent-color); border-color: #bfdbfe;
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.1);
        }

        /* --- Tables --- */
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { 
            background: #f8fafc; font-size: 11px; text-transform: uppercase; 
            color: var(--text-secondary); border-bottom: 2px solid #e2e8f0; 
            padding: 10px; font-weight: 700; letter-spacing: 0.05em; text-align: center;
        }
        td { 
            border-bottom: 1px solid #e2e8f0; padding: 8px 4px; font-size: 13px; 
            text-align: center; font-weight: 600; color: var(--text-primary);
        }
        
        .qc-output { font-family: 'JetBrains Mono', monospace; font-weight: 800; }

        /* --- Side Panel --- */
        #history-panel { 
            position: fixed; top: 0; right: 0; height: 100vh; width: 300px; z-index: 1000; 
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px);
            border-left: 1px solid #cbd5e1; box-shadow: -10px 0 25px -5px rgba(0, 0, 0, 0.05); 
            display: flex; flex-direction: column;
        }
        #history-panel.minimized { transform: translateX(320px); }

        #history-trigger {
            position: fixed; right: 0; top: 50%; transform: translateY(-50%);
            background: var(--text-primary); color: white; padding: 20px 8px; 
            border-radius: 8px 0 0 8px; cursor: pointer; z-index: 999; 
            writing-mode: vertical-rl; text-orientation: mixed;
            font-size: 10px; font-weight: 800; letter-spacing: 2px; 
            box-shadow: -4px 0 15px rgba(0,0,0,0.1); transition: 0.3s;
        }

        /* --- Loader --- */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #f8fafc; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; z-index: 9999;
            transition: opacity 0.5s;
        }
        .loader-mecha {
            width: 50px; height: 50px; border: 4px solid #e2e8f0;
            border-top: 4px solid var(--accent-color); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-out { opacity: 0; visibility: hidden; }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    
    <canvas id="mecha-canvas"></canvas>

    <div id="splash-screen">
        <div class="loader-mecha"></div>
        <div class="mt-4 text-center">
            <p class="text-slate-800 font-bold text-sm tracking-[0.3em] uppercase italic">PUMP TUNING</p>
            <p class="text-blue-500 text-[9px] font-mono font-bold tracking-widest mt-1">SYSTEM V.2.1.MECHA</p>
        </div>
    </div>

    <div id="history-panel" class="minimized">
        <div class="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
            <span class="text-[11px] font-bold text-slate-600 font-mono uppercase">/// CLOUD_ARCHIVE</span>
            <button onclick="toggleHistory()" class="text-slate-400 hover:text-red-500"><i class="fas fa-times"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto p-3 space-y-2" id="history-list"></div>
    </div>
    <div id="history-trigger" onclick="toggleHistory(event)"><i class="fas fa-history mb-2"></i> HISTORY</div>

    <div id="scaler-context">
        
        <header class="glass-mecha p-5 flex justify-between items-center no-print">
            <div class="flex items-center gap-4">
                <a href="index.html" class="h-10 w-10 bg-white rounded-lg flex items-center justify-center text-slate-600 shadow-sm border border-slate-200 hover:text-blue-600 transition-all">
                    <i class="fas fa-home"></i>
                </a>
                <div>
                    <h1 class="text-2xl font-bold text-slate-800 leading-none tracking-tight uppercase" style="font-family: 'JetBrains Mono'">HYDRAULIC <span class="text-blue-600">TUNER</span></h1>
                    <div class="flex items-center gap-2 mt-1">
                        <div id="status-dot" class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
                        <p id="sync-status" class="text-[9px] font-bold text-slate-400 tracking-widest uppercase">NEW ENTRY MODE</p>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-2 items-center">
                <div class="bg-slate-100 p-1 rounded-lg border border-slate-200 flex">
                    <button onclick="switchTab('general')" id="tab-gen" class="tab-btn active">General</button>
                    <button onclick="switchTab('pump')" id="tab-pump" class="tab-btn">Pump</button>
                </div>
                <button onclick="prepareNewEntry()" class="btn-mecha bg-white text-slate-600 border border-slate-200 h-9 w-9 rounded shadow-sm hover:text-blue-600">
                    <i class="fas fa-plus"></i>
                </button>
                <button onclick="saveToCloud()" class="btn-mecha bg-blue-600 text-white h-9 px-4 rounded shadow-md shadow-blue-200 hover:bg-blue-500">
                    <span class="text-[10px] font-black uppercase tracking-wider">SYNC</span>
                </button>
            </div>
        </header>

        <div class="glass-mecha p-6">
            <input type="hidden" id="current_record_id">
            <div class="flex justify-between items-end mb-4 border-b border-slate-200 pb-2">
                <span class="text-xs font-bold text-slate-400 font-mono">/// UNIT_PARAMETERS</span>
                <span class="text-[10px] text-blue-500 font-bold font-mono" id="display-nik">GUEST</span>
                <input type="hidden" id="nik">
            </div>

            <div class="grid grid-cols-4 gap-4">
                <div class="col-span-1"><label class="header-label">Date</label><input type="date" id="test_date" class="input-mecha !p-2"></div>
                <div class="col-span-1"><label class="header-label">Model</label><input type="text" id="unit_model" class="input-mecha !p-2 uppercase" placeholder="EX3600-6"></div>
                <div class="col-span-1"><label class="header-label">Serial No</label><input type="text" id="serial_num" class="input-mecha !p-2 uppercase font-mono" placeholder="SN12345"></div>
                <div class="col-span-1"><label class="header-label">HM</label><input type="number" id="hour_meter" class="input-mecha !p-2 font-mono" placeholder="0.0"></div>
                <div class="col-span-4"><label class="header-label">Technician</label><input type="text" id="nama_pic" class="input-mecha input-readonly" readonly></div>
            </div>
        </div>

        <div id="section-general" class="space-y-4 fade-in">
            <div class="glass-mecha">
                <div class="bg-slate-50 p-3 border-b border-slate-200">
                    <h3 class="text-[10px] font-black text-slate-500 uppercase tracking-widest"><i class="fas fa-microchip mr-2"></i>Component History</h3>
                </div>
                <table class="w-full">
                    <thead><tr><th class="text-left pl-4">Component</th><th>Serial</th><th>Part No</th><th>Lifetime</th><th>Model</th></tr></thead>
                    <tbody id="comp-history-body"></tbody>
                </table>
            </div>

            <div class="glass-mecha">
                <div class="bg-slate-50 p-3 border-b border-slate-200">
                    <h3 class="text-[10px] font-black text-slate-500 uppercase tracking-widest"><i class="fas fa-gauge-high mr-2"></i>Main Relief (Kgf/cm²)</h3>
                </div>
                <div class="p-5 grid grid-cols-4 gap-4" id="pump-relief-grid"></div>
                <div class="bg-blue-50/50 py-2 text-center border-t border-slate-100">
                    <span class="text-[9px] font-bold text-blue-400 tracking-[0.2em] uppercase">STD: 300 - 320 Kgf/cm²</span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="glass-mecha mb-0">
                    <div class="bg-slate-50 p-3 border-b border-slate-200">
                        <h3 class="text-[10px] font-black text-slate-500 uppercase"><i class="fas fa-bolt mr-2"></i>Engine RPM</h3>
                    </div>
                    <table class="w-full">
                        <thead><tr><th class="text-left pl-4">Item</th><th>Std</th><th class="text-blue-600">Before</th><th class="text-green-600">After</th></tr></thead>
                        <tbody id="engine-speed-body"></tbody>
                    </table>
                </div>

                <div class="glass-mecha mb-0">
                    <div class="bg-slate-50 p-3 border-b border-slate-200">
                        <h3 class="text-[10px] font-black text-slate-500 uppercase"><i class="fas fa-stopwatch mr-2"></i>Cycle Time</h3>
                    </div>
                    <table class="w-full">
                        <thead><tr><th class="text-left pl-4">Action</th><th>Std</th><th class="text-blue-600">Bef</th><th class="text-green-600">Aft</th></tr></thead>
                        <tbody id="cycle-time-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="section-pump" class="hidden space-y-4 fade-in">
            <div class="flex justify-between items-center bg-slate-800 text-white p-3 rounded-xl shadow-lg mb-4 mx-1">
                <span class="text-[11px] font-bold uppercase tracking-wider pl-2"><i class="fas fa-cogs mr-2"></i>Pump <span id="active-p-num" class="text-blue-400 font-mono text-lg">1</span> Analysis</span>
                <select id="pump-select" onchange="changePump(this.value)" class="bg-slate-700 text-[11px] font-bold border border-slate-600 rounded px-3 py-1 outline-none focus:border-blue-400">
                    <option value="1">PUMP 1</option><option value="2">PUMP 2</option>
                    <option value="3">PUMP 3</option><option value="4">PUMP 4</option>
                    <option value="5">PUMP 5</option><option value="6">PUMP 6</option>
                    <option value="7">PUMP 7</option><option value="8">PUMP 8</option>
                </select>
            </div>

            <div id="pump-tables-container"></div>

            <div class="glass-mecha p-4 bg-white">
                <div style="height: 300px; width: 100%;">
                    <canvas id="nikChart"></canvas>
                </div>
            </div>
            
            <textarea id="nik-notes" class="w-full glass-mecha p-4 text-[12px] font-semibold h-24 focus:outline-none resize-none bg-white/50" placeholder="Technical analysis notes..."></textarea>
        </div>

        <footer class="text-center py-8">
            <p class="text-slate-300 text-[9px] uppercase font-bold tracking-[0.4em]">NIK TERMINAL SYSTEM</p>
        </footer>
    </div>

    <script>
        // --- CONFIGURATION ---
        const SB_URL = "https://corpgiuxyhfxdnqwwmlv.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNvcnBnaXV4eWhmeGRucXd3bWx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDMwNzcsImV4cCI6MjA4NTg3OTA3N30.PMp5yZOISYrBG0UUcIGaXUPnmEAaWVKgQ3Y1W8Nea_E";
        const sb = supabase.createClient(SB_URL, SB_KEY);

        // --- STATE ---
        let currentNik = localStorage.getItem('userNIK');
        let currentRecordId = null;
        let currentPump = "1";
        let nikChart;
        let masterStore = JSON.parse(localStorage.getItem('nik_master_store')) || {};

        const pumpFlowStd = [
            { label: 'P50', p: '50 ± 2', ne: 1900, i: 1.02, np: 1838, min: 524, max: 535, std: '502 ± 5' },
            { label: 'P137', p: '137 ± 5', ne: 1900, i: 1.02, np: 1838, min: 512, max: 523, std: '491 ± 5' },
            { label: 'P170', p: '170', ne: 1900, i: 1.02, np: 1838, min: 422, max: 453, std: '415 ± 15' },
            { label: 'P250', p: '250 ± 5', ne: 1900, i: 1.02, np: 1838, min: 284, max: 315, std: '284 ± 15' },
            { label: 'P300', p: '300 ± 2', ne: 1900, i: 1.02, np: 1838, min: 234, max: 245, std: '227 ± 5' }
        ];

        // --- MECHA PARTICLE ENGINE ---
        const canvas = document.getElementById('mecha-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];

        function resizeCanvas() { 
            canvas.width = window.innerWidth; 
            canvas.height = window.innerHeight; 
        }

        class MechaParticle {
            constructor() { this.reset(); }
            reset() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 2 + 0.5;
                this.speedY = (Math.random() - 0.5) * 0.5; 
                this.speedX = (Math.random() - 0.5) * 0.5;
                this.opacity = Math.random() * 0.5 + 0.1;
            }
            update() { 
                this.y += this.speedY; this.x += this.speedX; 
                if (this.y < 0 || this.y > canvas.height || this.x < 0 || this.x > canvas.width) this.reset(); 
            }
            draw() { 
                ctx.fillStyle = `rgba(148, 163, 184, ${this.opacity})`; 
                ctx.beginPath(); ctx.rect(this.x, this.y, this.size, this.size); ctx.fill(); 
            }
        }

        function initParticles() { 
            particles = []; 
            for (let i = 0; i < 60; i++) particles.push(new MechaParticle()); 
        }
        function animateParticles() { 
            ctx.clearRect(0, 0, canvas.width, canvas.height); 
            particles.forEach(p => { p.update(); p.draw(); }); 
            requestAnimationFrame(animateParticles); 
        }

        // --- INITIALIZATION ---
        window.onload = async () => {
            resizeCanvas();
            initParticles();
            animateParticles();
            runAutoScale();
            initGeneralForms();
            await syncTechnicianProfile();
            fetchHistory();

            const dispNik = document.getElementById('display-nik');
            const valNik = document.getElementById('nik');
            const dateInp = document.getElementById('test_date');
            
            if(dispNik) dispNik.innerText = currentNik || 'GUEST';
            if(valNik) valNik.value = currentNik || 'GUEST';
            if(dateInp) dateInp.valueAsDate = new Date();

            setTimeout(() => {
                document.getElementById('splash-screen').classList.add('fade-out');
                setTimeout(() => document.getElementById('splash-screen').style.display = 'none', 500);
            }, 1000);
        };

        window.addEventListener('resize', () => { resizeCanvas(); runAutoScale(); });

        // --- CORE LOGIC ---
        function runAutoScale() {
            const scaler = document.getElementById('scaler-context');
            const targetWidth = 720;
            const windowWidth = window.innerWidth;
            const scaleRatio = windowWidth < targetWidth ? windowWidth / targetWidth : 1;
            
            scaler.style.transform = `scale(${scaleRatio})`;
            scaler.style.marginBottom = windowWidth < targetWidth ? `-${(1 - scaleRatio) * scaler.offsetHeight}px` : "0px";
        }

        async function syncTechnicianProfile() {
            const nameInput = document.getElementById('nama_pic');
            if (!currentNik) return;
            try {
                const { data } = await sb.from('users').select('full_name').eq('nik', currentNik).single();
                if (data && data.full_name) {
                    nameInput.value = data.full_name.toUpperCase();
                    localStorage.setItem('userName', data.full_name.toUpperCase());
                } else {
                    nameInput.value = localStorage.getItem('userName') || "UNKNOWN";
                }
            } catch (err) { console.error(err); }
        }

        function switchTab(t) {
            document.getElementById('section-general').classList.toggle('hidden', t !== 'general');
            document.getElementById('section-pump').classList.toggle('hidden', t !== 'pump');
            document.getElementById('tab-gen').classList.toggle('active', t === 'general');
            document.getElementById('tab-pump').classList.toggle('active', t === 'pump');
            
            if(t === 'pump') { 
                if(!nikChart) initChart(); 
                renderPumpAnalysis(); 
            }
        }

        // --- DRAWER & EVENT LOGIC (UPDATED) ---
        function toggleHistory(event) {
            if(event) event.stopPropagation();
            const panel = document.getElementById('history-panel');
            panel.classList.toggle('minimized');
            if(!panel.classList.contains('minimized')) fetchHistory();
        }

        // Auto Close Drawer Logic
        document.addEventListener('click', (e) => {
            const panel = document.getElementById('history-panel');
            const trigger = document.getElementById('history-trigger');
            
            // Jika klik BUKAN di panel, dan BUKAN di tombol trigger, dan panel sedang terbuka
            if (!panel.contains(e.target) && !trigger.contains(e.target) && !panel.classList.contains('minimized')) {
                panel.classList.add('minimized');
            }
        });

        // --- FORMS & CALCULATION ---
        function initGeneralForms() {
            const compBody = document.getElementById('comp-history-body');
            const pumpGrid = document.getElementById('pump-relief-grid');
            const engBody = document.getElementById('engine-speed-body');
            const cycBody = document.getElementById('cycle-time-body');

            const comps = ["ENGINE", "PUMP 1-2", "PUMP 3-4", "PUMP 5-6", "PUMP 7-8"];
            compBody.innerHTML = comps.map(c => `<tr><td class="p-2 font-bold text-[10px] text-left pl-4">${c}</td><td><input type="text" class="input-mecha !p-1 text-center data-comp"></td><td><input type="text" class="input-mecha !p-1 text-center data-comp"></td><td><input type="number" class="input-mecha !p-1 text-center data-comp"></td><td><input type="text" class="input-mecha !p-1 text-center data-comp"></td></tr>`).join('');

            pumpGrid.innerHTML = Array.from({length:8}, (_,i)=>`<div><label class="text-[9px] font-bold text-slate-400 mb-1 block">P${i+1}</label><input type="number" class="input-mecha text-center font-mono text-blue-600 data-pump"></div>`).join('');

            const engData = [{n: "Low Idle", s: "780-820"}, {n: "High Idle", s: "1850-1950"}, {n: "Auto Idle", s: "1350-1450"}, {n: "Relief Idle", s: "1770-1830"}];
            engBody.innerHTML = engData.map(e => `<tr><td class="p-2 font-bold text-slate-700 text-[10px] pl-4 text-left">${e.n}</td><td class="text-[10px] font-bold text-slate-400 font-mono">${e.s}</td><td class="p-1"><input type="number" class="input-mecha data-eng text-center"></td><td class="p-1"><input type="number" class="input-mecha data-eng text-center"></td></tr>`).join('');

            const actions = [{n: "Boom Raise", s: "8.2±0.5"},{n: "Arm Roll-in", s: "7.0±0.5"},{n: "Arm Roll-out", s: "7.0±0.5"},{n: "Bucket Roll-in", s: "4.7±0.5"},{n: "Bucket Roll-out", s: "4.2±0.5"},{n: "Swing RH", s: "57±3"},{n: "Swing LH", s: "57±3"}];
            cycBody.innerHTML = actions.map(a => `<tr><td class="text-[10px] text-left font-bold p-2 pl-4 text-slate-700">${a.n}</td><td class="text-[10px] font-mono text-slate-400 font-bold">${a.s}</td><td class="p-1"><input type="number" step="0.1" class="input-mecha text-center data-cyc"></td><td class="p-1"><input type="number" step="0.1" class="input-mecha text-center data-cyc"></td></tr>`).join('');
        }

        function changePump(v) { 
            currentPump = v; 
            document.getElementById('active-p-num').innerText = v; 
            renderPumpAnalysis(); 
        }

        // --- RENDER PUMP ANALYSIS (UPDATED COLOR LOGIC) ---
        function renderPumpAnalysis() {
            const container = document.getElementById('pump-tables-container');
            const pumpData = masterStore[currentPump] || { valuesBefore: [], valuesAfter: [] };
            
            const buildTable = (title, type) => {
                const values = (type === 'after' ? pumpData.valuesAfter : pumpData.valuesBefore) || [];
                return `
                    <div class="glass-mecha mb-4">
                        <div class="bg-slate-50 p-2 border-b border-slate-200 flex justify-between items-center">
                            <h3 class="text-[10px] font-black text-slate-600 uppercase px-2 tracking-wider">${title}</h3>
                        </div>
                        <table class="w-full">
                            <thead><tr><th>Point</th><th>Press</th><th class="text-blue-600">Measure Q</th><th>QC Calc</th><th>Std QC</th></tr></thead>
                            <tbody>
                                ${pumpFlowStd.map((item, i) => {
                                    const val = values[i] || '';
                                    const qc = val ? Math.round((item.np * val) / (item.i * item.ne)) : '-';
                                    
                                    // --- LOGIKA WARNA BARU ---
                                    let statusClass = 'text-slate-400';
                                    if (qc !== '-') {
                                        const [base, tol] = item.std.split('±').map(Number);
                                        const min = base - tol;
                                        const max = base + tol;

                                        if (qc < min) {
                                            // Dibawah standar = Kuning (Amber)
                                            statusClass = 'text-amber-500 font-black';
                                        } else if (qc > max) {
                                            // Diatas standar = Merah
                                            statusClass = 'text-red-500 font-black';
                                        } else {
                                            // Masuk standar = Hijau
                                            statusClass = 'text-emerald-500 font-black';
                                        }
                                    }

                                    return `<tr>
                                        <td class="font-bold text-slate-700">${item.label}</td>
                                        <td class="text-slate-400 font-mono text-[10px]">${item.p}</td>
                                        <td><input type="number" class="input-mecha !p-1 text-center w-20 font-mono text-blue-700" data-type="${type}" data-idx="${i}" value="${val}" oninput="updatePumpValueRealtime(this)"></td>
                                        <td class="qc-output ${statusClass}">${qc}</td>
                                        <td class="font-bold text-slate-400 text-[10px] font-mono">${item.std}</td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>`;
            };
            container.innerHTML = buildTable('1. BEFORE ADJUSTMENT', 'before') + buildTable('2. AFTER ADJUSTMENT', 'after');
            updateChart();
        }

        function updatePumpValueRealtime(el) {
            const type = el.dataset.type;
            const idx = parseInt(el.dataset.idx);
            if(!masterStore[currentPump]) masterStore[currentPump] = { valuesBefore: [], valuesAfter: [] };
            masterStore[currentPump][type === 'after' ? 'valuesAfter' : 'valuesBefore'][idx] = el.value;
            localStorage.setItem('nik_master_store', JSON.stringify(masterStore));
            updateChart(); // Chart update juga akan memanggil render ulang (jika diperlukan) atau realtime chart update
            
            // Kita panggil renderPumpAnalysis agar warna QC Calc langsung berubah saat mengetik
            // Debounce sedikit supaya tidak berat jika diperlukan, tapi untuk 5 field aman langsung
            renderPumpAnalysis(); 
            // Note: memanggil renderPumpAnalysis akan me-reset fokus input, 
            // jadi kita harus menahan fokus. 
            // PERBAIKAN: Update DOM elemen spesifik saja untuk warna tanpa re-render seluruh tabel
            // Namun untuk kesederhanaan, kode di atas sudah cukup responsif. 
            // Agar fokus tidak hilang, kita kembalikan fokus ke elemen yang sedang diedit:
            const newInput = document.querySelector(`input[data-type="${type}"][data-idx="${idx}"]`);
            if(newInput) {
                newInput.focus();
                // Set cursor to end
                const val = newInput.value;
                newInput.value = '';
                newInput.value = val;
            }
        }

        function initChart() {
            const ctx = document.getElementById('nikChart').getContext('2d');
            if (nikChart) nikChart.destroy();
            nikChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: pumpFlowStd.map(d => d.label),
                    datasets: [
                        { label: 'Min', data: pumpFlowStd.map(i => parseInt(i.std.split('±')[0]) - parseInt(i.std.split('±')[1])), borderColor: '#cbd5e1', borderDash: [5,5], pointRadius: 0, borderWidth: 1 },
                        { label: 'Max', data: pumpFlowStd.map(i => parseInt(i.std.split('±')[0]) + parseInt(i.std.split('±')[1])), borderColor: '#cbd5e1', borderDash: [5,5], pointRadius: 0, borderWidth: 1 },
                        { label: 'Before', data: [], borderColor: '#94a3b8', tension: 0.3, pointRadius: 3, borderWidth: 2 },
                        { label: 'After', data: [], borderColor: '#2563eb', tension: 0.3, pointRadius: 4, borderWidth: 2, backgroundColor: 'rgba(37, 99, 235, 0.1)', fill: true }
                    ]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { labels: { font: { family: 'Rajdhani', size: 11 } } } },
                    scales: { y: { grid: { color: '#f1f5f9' } }, x: { grid: { display: false } } }
                }
            });
        }

        function updateChart() {
            if(!nikChart) return;
            const pumpData = masterStore[currentPump] || { valuesBefore: [], valuesAfter: [] };
            const calcQC = (v, i) => v ? Math.round((pumpFlowStd[i].np * v) / (pumpFlowStd[i].i * pumpFlowStd[i].ne)) : null;
            nikChart.data.datasets[2].data = (pumpData.valuesBefore || []).map(calcQC);
            nikChart.data.datasets[3].data = (pumpData.valuesAfter || []).map(calcQC);
            nikChart.update();
        }

        // --- CLOUD SYNC ---
        async function fetchHistory() {
            const list = document.getElementById('history-list');
            const { data } = await sb.from('pump_performance_reports').select('*').order('created_at', { ascending: false }).limit(10);
            if (data) {
                list.innerHTML = data.map(rec => `
                    <div class="flex justify-between items-center p-3 bg-white rounded-lg border border-slate-200 shadow-sm hover:border-blue-300 transition-all cursor-pointer" onclick="loadRecord('${rec.id}')">
                        <div>
                            <p class="text-[11px] font-bold text-slate-800">${rec.unit_model || 'UNIT'} - ${rec.serial_number || 'SN'}</p>
                            <p class="text-[9px] text-slate-400 font-mono">${new Date(rec.test_date).toLocaleDateString()}</p>
                        </div>
                        <i class="fas fa-chevron-right text-slate-300 text-[10px]"></i>
                    </div>`).join('');
            }
        }

        async function saveToCloud() {
            const btn = document.querySelector('button[onclick="saveToCloud()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i>`;
            
            const recId = document.getElementById('current_record_id').value;
            const record = {
                test_date: document.getElementById('test_date').value,
                nik: document.getElementById('nik').value,
                unit_model: document.getElementById('unit_model').value.toUpperCase(),
                serial_number: document.getElementById('serial_num').value.toUpperCase(),
                hour_meter: document.getElementById('hour_meter').value,
                component_history: Array.from(document.querySelectorAll('.data-comp')).map(i => i.value),
                pump_relief_values: Array.from(document.querySelectorAll('.data-pump')).map(i => i.value),
                engine_speed_values: Array.from(document.querySelectorAll('.data-eng')).map(i => i.value),
                cycle_time_values: Array.from(document.querySelectorAll('.data-cyc')).map(i => i.value),
                all_pumps_data: masterStore
            };
            
            const { error } = recId ? await sb.from('pump_performance_reports').update(record).eq('id', recId) : await sb.from('pump_performance_reports').insert([record]);
            
            btn.innerHTML = originalText;
            if (error) alert("Sync Failed: " + error.message); 
            else { 
                alert("✅ Data Synced to Cloud!"); 
                prepareNewEntry(); 
                fetchHistory(); 
            }
        }

        async function loadRecord(id) {
            const { data } = await sb.from('pump_performance_reports').select('*').eq('id', id).single();
            if (data) {
                document.getElementById('current_record_id').value = data.id;
                document.getElementById('unit_model').value = data.unit_model;
                document.getElementById('serial_num').value = data.serial_number;
                document.getElementById('test_date').value = data.test_date;
                document.getElementById('hour_meter').value = data.hour_meter;
                masterStore = data.all_pumps_data || {};
                localStorage.setItem('nik_master_store', JSON.stringify(masterStore));
                
                const setVal = (sel, vals) => document.querySelectorAll(sel).forEach((el, i) => el.value = vals[i] || '');
                setVal('.data-comp', data.component_history || []);
                setVal('.data-pump', data.pump_relief_values || []);
                setVal('.data-eng', data.engine_speed_values || []);
                setVal('.data-cyc', data.cycle_time_values || []);
                
                if(!document.getElementById('section-pump').classList.contains('hidden')) renderPumpAnalysis();
                document.getElementById('history-panel').classList.add('minimized');
                
                document.getElementById('sync-status').innerText = "EDIT MODE";
                document.getElementById('status-dot').className = "w-2 h-2 bg-amber-400 rounded-full animate-pulse";
            }
        }

        function prepareNewEntry() {
            document.getElementById('current_record_id').value = "";
            document.querySelectorAll('input:not([readonly])').forEach(i => i.value = "");
            document.getElementById('test_date').valueAsDate = new Date();
            masterStore = {};
            localStorage.removeItem('nik_master_store');
            renderPumpAnalysis();
            document.getElementById('sync-status').innerText = "NEW ENTRY MODE";
            document.getElementById('status-dot').className = "w-2 h-2 bg-emerald-500 rounded-full animate-pulse";
        }
    </script>
</body>
</html>
