<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hydraulic Test Pro | NIK Terminal</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=JetBrains+Mono:wght@700&display=swap');
        
        html, body { background: #f1f5f9; margin: 0; padding: 0; width: 100%; overflow-x: hidden; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }

        /* Scaler sync with Pump Analysis */
        #nik-scaler { width: 720px; transform-origin: top center; padding: 15px; box-sizing: border-box; transition: transform 0.2s ease-out; }
        
        .glass-card { background: white; border-radius: 16px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); overflow: hidden; }
        
        /* Input Styling Sync */
        .header-label { font-size: 8px; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px; display: block; }
        
        .input-glacial { 
            width: 100%; padding: 10px; font-size: 12px; border: 2px solid #e2e8f0; 
            border-radius: 10px; font-weight: 700; color: #1e3a8a; 
            outline: none; transition: all 0.2s; background: #f8fafc;
        }
        .input-glacial:focus { border-color: #3b82f6; background: white; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .input-readonly { background: #f1f5f9 !important; color: #94a3b8 !important; cursor: not-allowed; border-style: dashed; }

        /* Table Styling Sync */
        .table-custom { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .table-custom th { font-size: 8px; color: #64748b; background: #f8fafc; padding: 10px 5px; text-transform: uppercase; font-weight: 800; border-bottom: 2px solid #e2e8f0; text-align: center; }
        .table-custom td { padding: 8px 5px; font-size: 11px; border-bottom: 1px solid #f1f5f9; text-align: center; font-weight: 600; }

        /* Validation Colors Sync */
        .val-ok { border-color: #10b981 !important; background-color: #f0fdf4 !important; color: #065f46 !important; }
        .val-err { border-color: #ef4444 !important; background-color: #fef2f2 !important; color: #991b1b !important; }

        #loadingOverlay { position: fixed; inset: 0; background: rgba(30, 58, 138, 0.9); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        
        @media print { .no-print { display: none; } #nik-scaler { transform: scale(1) !important; width: 100%; } }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div class="w-10 h-10 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 font-black text-white text-[10px] tracking-widest uppercase italic">NIK Cloud Sync Active...</p>
    </div>

    <div id="nik-scaler">
        <div class="mb-3 no-print flex justify-between items-center px-1">
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 bg-blue-600 rounded-full animate-pulse"></div>
                <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Hydraulic Diagnostic Module</span>
            </div>
            <span class="text-[8px] font-black text-slate-300 tracking-[0.3em] uppercase">System v2.6.4</span>
        </div>

        <div class="glass-card mb-4 p-5 border-l-8 border-blue-600 flex justify-between items-center bg-white">
            <div class="flex-1 grid grid-cols-4 gap-4">
                <div class="col-span-1">
                    <span class="header-label text-blue-600">Test Date</span>
                    <input type="date" id="test_date" class="input-glacial !p-2 !text-[11px]">
                </div>
                <div class="col-span-1">
                    <span class="header-label">Unit Model</span>
                    <input type="text" id="unit_model" class="input-glacial !p-2 !text-[11px] uppercase" placeholder="EX3600-6">
                </div>
                <div class="col-span-1">
                    <span class="header-label">Serial Number</span>
                    <input type="text" id="serial_num" class="input-glacial !p-2 !text-[11px] uppercase" placeholder="SN12345">
                </div>
                <div class="col-span-1">
                    <span class="header-label">Operator NIK</span>
                    <p id="user-nik-display" class="text-xs font-black text-blue-600 mt-2">LOADING...</p>
                </div>
            </div>
            <div class="ml-6 flex flex-col gap-2">
                <button onclick="saveToCloud()" id="btn-save" class="bg-blue-600 text-white px-4 py-2 rounded-xl font-black text-[9px] uppercase shadow-md hover:bg-blue-700 transition-all">
                    <i class="fas fa-cloud-upload-alt mr-1"></i> Sync Cloud
                </button>
                <button onclick="newForm()" class="text-[8px] font-bold text-slate-400 uppercase hover:text-red-500 transition-colors">
                    <i class="fas fa-redo mr-1"></i> Reset
                </button>
            </div>
        </div>

        <form id="mainForm" class="space-y-4">
            <div class="glass-card">
                <div class="bg-slate-50 p-2 border-b border-slate-100 flex items-center justify-between">
                    <h3 class="text-[9px] font-black text-slate-500 uppercase px-2"><i class="fas fa-history mr-2"></i>1. Component & Oil History</h3>
                    <input type="number" id="hour_meter" class="bg-white border-2 border-blue-100 rounded-lg px-2 py-1 text-[10px] font-black w-24 outline-none" placeholder="HM UNIT">
                </div>
                <table class="table-custom">
                    <thead>
                        <tr><th style="width:120px" class="text-left pl-4">Component</th><th>Serial Number</th><th>Part Number</th><th>Lifetime</th><th>Model</th></tr>
                    </thead>
                    <tbody id="component-body">
                        <script>
                            const comps = ["ENGINE", "PUMP 1-2", "PUMP 3-4", "PUMP 5-6", "PUMP 7-8", "SWING DEVICE", "TRAVEL DEVICE"];
                            comps.forEach(c => {
                                document.write(`
                                    <tr>
                                        <td class="text-left pl-4 font-black text-slate-700 text-[10px]">${c}</td>
                                        <td><input type="text" class="input-glacial !p-1.5 !text-[10px] bg-transparent border-0 focus:bg-white data-comp"></td>
                                        <td><input type="text" class="input-glacial !p-1.5 !text-[10px] bg-transparent border-0 focus:bg-white data-comp"></td>
                                        <td><input type="number" class="input-glacial !p-1.5 !text-[10px] bg-transparent border-0 focus:bg-white data-comp"></td>
                                        <td><input type="text" class="input-glacial !p-1.5 !text-[10px] bg-transparent border-0 focus:bg-white data-comp"></td>
                                    </tr>
                                `);
                            });
                        </script>
                    </tbody>
                </table>
            </div>

            <div class="glass-card">
                <div class="bg-slate-50 p-2 border-b border-slate-100">
                    <h3 class="text-[9px] font-black text-slate-500 uppercase px-2"><i class="fas fa-gauge-high mr-2"></i>2. Relief Pressures (Kgf/cm²)</h3>
                </div>
                <div class="p-4 grid grid-cols-4 gap-4">
                    <script>
                        for(let i=1; i<=8; i++) {
                            document.write(`
                                <div class="space-y-1">
                                    <label class="text-[9px] font-black text-slate-400 uppercase">Pump ${i}</label>
                                    <input type="number" class="input-glacial text-center validate-press" data-min="300" data-max="320" placeholder="-">
                                </div>
                            `);
                        }
                    </script>
                </div>
                <div class="bg-blue-50 py-2 text-center border-t border-blue-100">
                    <span class="text-[9px] font-black text-blue-400 tracking-widest uppercase italic">Standard Range: 300 ~ 320 Kgf/cm²</span>
                </div>
            </div>

            <div class="glass-card">
                <div class="bg-slate-50 p-2 border-b border-slate-100">
                    <h3 class="text-[9px] font-black text-slate-500 uppercase px-2"><i class="fas fa-bolt mr-2"></i>3. Engine Speed (RPM)</h3>
                </div>
                <table class="table-custom">
                    <thead>
                        <tr><th class="text-left pl-4">Condition</th><th>Standard</th><th class="text-blue-600">Before</th><th class="text-green-600">After</th></tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="text-left pl-4 font-bold text-slate-700">Low Idle</td>
                            <td class="text-slate-400 italic">780 ~ 820</td>
                            <td><input type="number" class="input-glacial !p-1.5 !w-24 text-center val-eng" data-min="780" data-max="820"></td>
                            <td><input type="number" class="input-glacial !p-1.5 !w-24 text-center val-eng" data-min="780" data-max="820"></td>
                        </tr>
                        <tr>
                            <td class="text-left pl-4 font-bold text-slate-700">High Idle</td>
                            <td class="text-slate-400 italic">1850 ~ 1950</td>
                            <td><input type="number" class="input-glacial !p-1.5 !w-24 text-center val-eng" data-min="1850" data-max="1950"></td>
                            <td><input type="number" class="input-glacial !p-1.5 !w-24 text-center val-eng" data-min="1850" data-max="1950"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </form>

        <div class="mt-4 glass-card no-print">
            <div class="bg-slate-900 p-2 flex justify-between items-center">
                <h3 class="text-[9px] font-black text-white uppercase px-2">Recent Cloud Syncs</h3>
                <i class="fas fa-cloud text-blue-400 mr-2 text-xs"></i>
            </div>
            <div class="max-h-40 overflow-y-auto">
                <table class="w-full text-[10px]">
                    <thead class="sticky top-0 bg-white shadow-sm">
                        <tr class="text-[8px] text-slate-400 uppercase font-black border-b">
                            <th class="p-2 text-left">Date</th><th>Unit Model</th><th>Technician</th><th class="text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="dbTableBody" class="font-bold text-slate-600"></tbody>
                </table>
            </div>
        </div>

        <footer class="mt-6 text-center no-print">
            <button onclick="window.print()" class="bg-white border border-slate-200 text-slate-500 px-6 py-2 rounded-xl font-black text-[10px] uppercase hover:bg-slate-50 transition-all">
                <i class="fas fa-print mr-2"></i> Generate Technical Report (PDF)
            </button>
            <p class="text-[8px] font-black text-slate-300 uppercase tracking-[0.4em] mt-4 italic">PT HEXINDO ADARO | NIK SECURED TERMINAL</p>
        </footer>
    </div>

    <script>
        const sb = supabase.createClient('https://corpgiuxyhfxdnqwwmlv.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNvcnBnaXV4eWhmeGRucXd3bWx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDMwNzcsImV4cCI6MjA4NTg3OTA3N30.PMp5yZOISYrBG0UUcIGaXUPnmEAaWVKgQ3Y1W8Nea_E');

        // --- GLOBAL SYNC LOGIC (SAMA DENGAN PUMP ANALYSIS) ---
        function setupNikSync() {
            const fields = ['unit_model', 'serial_num'];
            fields.forEach(id => {
                const el = document.getElementById(id);
                const saved = localStorage.getItem('nik_sync_' + id);
                if (saved) el.value = saved;
                el.addEventListener('input', () => { 
                    localStorage.setItem('nik_sync_' + id, el.value); 
                });
            });

            // Listen to storage changes from other tabs
            window.addEventListener('storage', (e) => {
                if (e.key && e.key.startsWith('nik_sync_')) {
                    const id = e.key.replace('nik_sync_', '');
                    const el = document.getElementById(id);
                    if (el) el.value = e.newValue;
                }
            });
        }

        // --- VALIDATION LOGIC ---
        function setupValidation() {
            document.querySelectorAll('.validate-press, .val-eng').forEach(input => {
                input.addEventListener('input', function() {
                    const val = parseFloat(this.value);
                    const min = parseFloat(this.dataset.min);
                    const max = parseFloat(this.dataset.max);
                    this.classList.remove('val-ok', 'val-err');
                    if(!isNaN(val)) {
                        if(val >= min && val <= max) this.classList.add('val-ok');
                        else this.classList.add('val-err');
                    }
                });
            });
        }

        // --- AUTO SCALER ---
        function handleAutoScale() {
            const scaler = document.getElementById('nik-scaler');
            const targetW = 720;
            const winW = window.innerWidth;
            if (winW < targetW) {
                const scale = winW / targetW;
                scaler.style.transform = `scale(${scale})`;
                scaler.style.marginBottom = `-${(1 - scale) * scaler.offsetHeight}px`;
            } else {
                scaler.style.transform = `scale(1)`;
                scaler.style.marginBottom = `0px`;
            }
        }

        async function saveToCloud() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = 'flex';
            
            // Logic Simpan Supabase Anda
            setTimeout(() => {
                overlay.style.display = 'none';
                alert("✅ Cloud Data Synchronized!");
                fetchData();
            }, 1000);
        }

        async function fetchData() {
            const { data } = await sb.from('pump_performance_reports').select('*').order('created_at', { ascending: false }).limit(5);
            const tbody = document.getElementById('dbTableBody');
            if(data) {
                tbody.innerHTML = data.map(item => `
                    <tr class="border-b border-slate-50 hover:bg-blue-50 transition-all cursor-pointer">
                        <td class="p-2">${item.test_date}</td>
                        <td class="text-blue-600">${item.unit_model}</td>
                        <td class="text-[9px]">${item.nik}</td>
                        <td class="text-center"><i class="fas fa-chevron-right text-slate-300"></i></td>
                    </tr>
                `).join('');
            }
        }

        function newForm() {
            if(confirm("Reset form? Identity remains synced.")) {
                document.getElementById('mainForm').reset();
            }
        }

        window.onload = () => {
            setupNikSync();
            setupValidation();
            handleAutoScale();
            fetchData();
            window.addEventListener('resize', handleAutoScale);
            document.getElementById('test_date').valueAsDate = new Date();
            document.getElementById('user-nik-display').innerText = localStorage.getItem('userNIK') || 'GUEST';
        };
    </script>
</body>
</html>
