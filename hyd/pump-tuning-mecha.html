<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pump Tune-Up | Mecha White</title>
    <link rel="manifest" href="../manifest.json">
    <meta name="theme-color" content="#f1f5f9">
    
    <script>
        if (localStorage.getItem('isLoggedIn') !== 'true') { window.location.replace('../login/login-mecha.html'); }
    </script>

    <script src="../js/tailwindcss.js"></script>
    <script src="../js/supabase-js@2.js"></script>
    <script src="../js/chart.js"></script>
    <link href="../css/all.min.css" rel="stylesheet">
    <link href="../css/rajdhani.css" rel="stylesheet">
    <link href="../css/jetbrain.css" rel="stylesheet">

    <style>
        :root {
            --base-width: 720px;
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.9);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --accent-color: #2563eb;
        }

        body { 
            font-family: 'Rajdhani', sans-serif; 
            background-color: #f1f5f9;
            background-image: radial-gradient(at 0% 0%, hsla(210,100%,96%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(210,100%,93%,1) 0, transparent 50%);
            min-height: 100vh; color: var(--text-primary); margin: 0; padding: 0; overflow-x: hidden;
            display: flex; justify-content: center; align-items: flex-start;
        }

        #mecha-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; opacity: 0.6; }

        #scaler-context {
            width: var(--base-width); transform-origin: top center; transition: transform 0.2s ease-out;
            flex-shrink: 0; padding: 1.5rem; position: relative; z-index: 10;
        }

        .glass-mecha { 
            background: var(--glass-bg); backdrop-filter: blur(20px) saturate(120%); 
            border: 1px solid var(--glass-border); box-shadow: var(--glass-shadow);
            border-radius: 16px; position: relative; overflow: hidden; margin-bottom: 1.5rem;
        }
        .glass-mecha::before {
            content: ''; position: absolute; top: 0; left: 0; width: 5px; height: 100%;
            background: linear-gradient(180deg, var(--accent-color), transparent); opacity: 0.6;
        }

        .header-label { 
            font-family: 'JetBrains Mono', monospace; font-size: 11px; font-weight: 700; 
            color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; 
            display: block; margin-bottom: 6px; 
        }
        .input-mecha { 
            border: 1px solid #cbd5e1; border-radius: 10px; font-weight: 600; width: 100%; 
            padding: 12px 14px; background: rgba(255, 255, 255, 0.7); font-size: 15px; 
            outline: none; transition: 0.3s; color: var(--text-primary); font-family: 'Rajdhani', sans-serif;
        }
        .input-mecha:focus { border-color: var(--accent-color); background: #ffffff; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .input-readonly { background: #e2e8f0 !important; color: #94a3b8 !important; border-style: dashed; pointer-events: none; }

        .btn-mecha { position: relative; overflow: hidden; transition: all 0.3s; transform: skew(-10deg); display: inline-flex; align-items: center; justify-content: center; }
        .btn-mecha span, .btn-mecha i { transform: skew(10deg); }
        .btn-mecha:active { transform: skew(-10deg) scale(0.95); }

        .tab-btn {
            background: transparent; border: 1px solid transparent; color: var(--text-secondary);
            font-weight: 700; text-transform: uppercase; font-size: 12px; padding: 10px 20px;
            border-radius: 8px; transition: all 0.3s; font-family: 'Rajdhani', sans-serif;
        }
        .tab-btn.active { background: #eff6ff; color: var(--accent-color); border-color: #bfdbfe; box-shadow: 0 2px 4px rgba(37, 99, 235, 0.1); }

        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { background: #f8fafc; font-size: 11px; text-transform: uppercase; color: var(--text-secondary); border-bottom: 2px solid #e2e8f0; padding: 12px; font-weight: 800; letter-spacing: 0.05em; text-align: center; }
        td { border-bottom: 1px solid #e2e8f0; padding: 10px 4px; font-size: 14px; text-align: center; font-weight: 600; color: var(--text-primary); }
        .qc-output { font-family: 'JetBrains Mono', monospace; font-weight: 800; }

        /* History Panel */
        #history-panel { 
            position: fixed; top: 0; right: 0; height: 100vh; width: 320px; z-index: 1000; 
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px);
            border-left: 1px solid #cbd5e1; box-shadow: -10px 0 30px rgba(0, 0, 0, 0.1); 
            display: flex; flex-direction: column;
        }
        #history-panel.minimized { transform: translateX(340px); }
        #history-trigger {
            position: fixed; right: 0; top: 50%; transform: translateY(-50%);
            background: var(--text-primary); color: white; padding: 24px 10px; 
            border-radius: 8px 0 0 8px; cursor: pointer; z-index: 999; 
            writing-mode: vertical-rl; text-orientation: mixed;
            font-size: 11px; font-weight: 800; letter-spacing: 2px; 
            box-shadow: -4px 0 15px rgba(0,0,0,0.1); transition: 0.3s;
        }

        #splash-screen { position: fixed; inset: 0; background: #f8fafc; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.5s; }
        .loader-mecha { width: 60px; height: 60px; border: 4px solid #e2e8f0; border-top: 4px solid var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .fade-out { opacity: 0; visibility: hidden; }
        
        /* --- MECHA ANIMATION ENGINE --- */
        .tab-panel {
            transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            opacity: 1;
            transform: translate3d(0, 0, 0) scale(1);
            filter: blur(0);
            width: 100%;
        }
        .mech-hidden { display: none !important; }
        
        /* Animasi Keluar ke Kiri (General -> Pump) */
        .slide-out-left {
            opacity: 0;
            transform: translate3d(-30px, 0, 0) scale(0.98);
            filter: blur(8px);
            pointer-events: none;
        }
        
        /* Animasi Masuk dari Kanan (Pump Starts) */
        .slide-in-right-start {
            opacity: 0;
            transform: translate3d(30px, 0, 0) scale(1.02);
            filter: blur(8px);
        }

        /* Animasi Keluar ke Kanan (Pump -> General) */
        .slide-out-right {
            opacity: 0;
            transform: translate3d(30px, 0, 0) scale(0.98);
            filter: blur(8px);
            pointer-events: none;
        }

        /* Animasi Masuk dari Kiri (General Starts) */
        .slide-in-left-start {
            opacity: 0;
            transform: translate3d(-30px, 0, 0) scale(1.02);
            filter: blur(8px);
        }
    </style>
</head>
<body>
    
    <canvas id="mecha-canvas"></canvas>

    <div id="splash-screen">
        <div class="loader-mecha"></div>
        <div class="mt-6 text-center">
            <p class="text-slate-800 font-bold text-sm tracking-[0.3em] uppercase italic">PUMP TUNING</p>
            <p class="text-blue-500 text-[10px] font-mono font-bold tracking-widest mt-1">SYSTEM V.2.2.VALIDATOR</p>
        </div>
    </div>

    <div id="history-panel" class="minimized">
        <div class="p-5 border-b border-slate-200 flex justify-between items-center bg-slate-50">
            <div>
                <span class="text-xs font-black text-slate-700 font-mono uppercase">/// CLOUD_ARCHIVE</span>
                <p class="text-[9px] text-slate-400 font-bold uppercase mt-1">Previous Adjustments</p>
            </div>
            <button onclick="toggleHistory()" class="text-slate-400 hover:text-red-500 text-xl"><i class="fas fa-times"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-3" id="history-list"></div>
    </div>
    <div id="history-trigger" onclick="toggleHistory(event)"><i class="fas fa-history mb-2"></i> HISTORY</div>

    <div id="scaler-context" class="space-y-6">
        
        <header class="glass-mecha p-6 flex justify-between items-center no-print">
            <div class="flex items-center gap-5">
                <a href="../index/index-mecha.html" class="h-12 w-12 bg-white rounded-xl flex items-center justify-center text-slate-600 shadow-sm border border-slate-200 hover:text-blue-600 transition-all text-xl">
                    <i class="fas fa-home"></i>
                </a>
                <div>
                    <h1 class="text-3xl font-bold text-slate-800 leading-none tracking-tight uppercase" style="font-family: 'JetBrains Mono'">HYDRAULIC <span class="text-blue-600">TUNER</span></h1>
                    <div class="flex items-center gap-2 mt-1">
                        <div id="status-dot" class="w-2.5 h-2.5 bg-emerald-500 rounded-full animate-pulse"></div>
                        <p id="sync-status" class="text-[10px] font-bold text-slate-400 tracking-widest uppercase">READY TO SYNC</p>
                    </div>
                </div>
            </div>
            <div class="flex gap-3 items-center">
                <div class="bg-slate-100 p-1.5 rounded-xl border border-slate-200 flex">
                    <button onclick="switchTab('general')" id="tab-gen" class="tab-btn active">General</button>
                    <button onclick="switchTab('pump')" id="tab-pump" class="tab-btn">Pump</button>
                </div>
                <button onclick="prepareNewEntry()" class="h-10 w-10 bg-white text-slate-500 border border-slate-200 rounded-xl shadow-sm hover:text-blue-600 hover:border-blue-300 transition-all flex items-center justify-center">
                    <i class="fas fa-plus text-sm"></i>
                </button>
                <button onclick="saveToCloud()" class="btn-mecha bg-blue-600 text-white h-10 px-6 rounded-xl shadow-lg shadow-blue-500/30 hover:bg-blue-500">
                    <span class="text-xs font-black uppercase tracking-wider">SYNC DATA</span>
                </button>
            </div>
        </header>

        <div class="glass-mecha p-7">
            <input type="hidden" id="current_record_id">
            <div class="flex justify-between items-end mb-5 border-b border-slate-200 pb-3">
                <span class="text-sm font-bold text-slate-400 font-mono">/// UNIT_PARAMETERS</span>
                <span class="text-xs text-blue-600 font-bold font-mono bg-blue-50 px-2 py-1 rounded" id="display-nik">GUEST</span>
                <input type="hidden" id="nik">
            </div>
            <div class="grid grid-cols-4 gap-5">
                <div class="col-span-1"><label class="header-label">Date</label><input type="date" id="test_date" class="input-mecha !p-3"></div>
                <div class="col-span-1"><label class="header-label">Model</label><input type="text" id="unit_model" class="input-mecha !p-3 uppercase font-bold text-blue-600" placeholder="EX3600-6"></div>
                <div class="col-span-1"><label class="header-label">Serial No</label><input type="text" id="serial_num" class="input-mecha !p-3 uppercase font-mono" placeholder="SN12345"></div>
                <div class="col-span-1"><label class="header-label">HM</label><input type="number" id="hour_meter" class="input-mecha !p-3 font-mono" placeholder="0.0"></div>
                <div class="col-span-4"><label class="header-label">Technician Name</label><input type="text" id="nama_pic" class="input-mecha input-readonly !bg-slate-100" readonly></div>
            </div>
        </div>

        <div id="section-general" class="tab-panel space-y-6">
            
            <div class="glass-mecha">
                <div class="bg-slate-50 p-4 border-b border-slate-200">
                    <h3 class="text-xs font-black text-slate-600 uppercase tracking-widest"><i class="fas fa-microchip mr-2 text-slate-400"></i>Component History</h3>
                </div>
                <div class="p-2">
                    <table class="w-full">
                        <thead><tr><th class="text-left pl-6">Component</th><th>Serial Number</th><th>Part No</th><th>Lifetime (Hr)</th><th>Note</th></tr></thead>
                        <tbody id="comp-history-body"></tbody>
                    </table>
                </div>
            </div>

            <div class="glass-mecha">
                <div class="bg-slate-50 p-4 border-b border-slate-200 flex justify-between items-center">
                    <h3 class="text-xs font-black text-slate-600 uppercase tracking-widest"><i class="fas fa-gauge-high mr-2 text-slate-400"></i>Main Relief Pressure</h3>
                    <span class="text-[10px] font-bold text-blue-500 bg-blue-50 px-2 py-1 rounded border border-blue-100">STD: 300 - 320 Kgf/cm²</span>
                </div>
                <div class="p-6 grid grid-cols-4 gap-5" id="pump-relief-grid"></div>
            </div>

            <div class="grid grid-cols-2 gap-6">
                <div class="glass-mecha mb-0">
                    <div class="bg-slate-50 p-4 border-b border-slate-200">
                        <h3 class="text-xs font-black text-slate-600 uppercase"><i class="fas fa-bolt mr-2 text-slate-400"></i>Engine RPM</h3>
                    </div>
                    <div class="p-2">
                        <table class="w-full">
                            <thead><tr><th class="text-left pl-6">Item</th><th>Std</th><th class="text-blue-600">Before</th><th class="text-emerald-600">After</th></tr></thead>
                            <tbody id="engine-speed-body"></tbody>
                        </table>
                    </div>
                </div>

                <div class="glass-mecha mb-0">
                    <div class="bg-slate-50 p-4 border-b border-slate-200">
                        <h3 class="text-xs font-black text-slate-600 uppercase"><i class="fas fa-stopwatch mr-2 text-slate-400"></i>Cycle Time</h3>
                    </div>
                    <div class="p-2">
                        <table class="w-full">
                            <thead><tr><th class="text-left pl-6">Action</th><th>Std (Sec)</th><th class="text-blue-600">Bef</th><th class="text-emerald-600">Aft</th></tr></thead>
                            <tbody id="cycle-time-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-pump" class="tab-panel mech-hidden space-y-6">
            <div class="flex justify-between items-center bg-slate-800 text-white p-4 rounded-2xl shadow-xl mx-1 border border-slate-700">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-slate-700 rounded-xl flex items-center justify-center text-blue-400 text-xl font-mono font-bold" id="active-p-num">1</div>
                    <div>
                        <span class="text-xs font-bold uppercase tracking-wider block text-slate-400">Active Pump</span>
                        <span class="text-sm font-black uppercase tracking-wide">Flow Analysis</span>
                    </div>
                </div>
                <div class="relative">
                    <select id="pump-select" onchange="changePump(this.value)" class="bg-slate-900 text-white text-xs font-bold border border-slate-600 rounded-lg pl-4 pr-10 py-2.5 outline-none focus:border-blue-500 appearance-none cursor-pointer hover:bg-slate-800">
                        <option value="1">PUMP 1</option><option value="2">PUMP 2</option>
                        <option value="3">PUMP 3</option><option value="4">PUMP 4</option>
                        <option value="5">PUMP 5</option><option value="6">PUMP 6</option>
                        <option value="7">PUMP 7</option><option value="8">PUMP 8</option>
                    </select>
                    <i class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 text-xs pointer-events-none"></i>
                </div>
            </div>

            <div id="pump-tables-container" class="space-y-6"></div>

            <div class="glass-mecha p-6 bg-white">
                <div class="flex justify-between items-center mb-4">
                     <h3 class="text-xs font-black text-slate-600 uppercase tracking-widest"><i class="fas fa-chart-line mr-2 text-slate-400"></i>Performance Graph</h3>
                </div>
                <div style="height: 320px; width: 100%;">
                    <canvas id="nikChart"></canvas>
                </div>
            </div>
            
            <textarea id="nik-notes" class="w-full glass-mecha p-5 text-sm font-semibold h-32 focus:outline-none resize-none bg-white/60 border-2 focus:border-blue-400 transition-colors" placeholder="Type technical analysis notes here..."></textarea>
        </div>

        <footer class="text-center py-10">
            <p class="text-slate-300 text-[10px] uppercase font-bold tracking-[0.4em]">HEXINDO ADARO PROJECT 2026</p>
        </footer>
    </div>

    <script>
        // --- CONFIG ---
        const CONFIG = {
            SB_URL: "https://corpgiuxyhfxdnqwwmlv.supabase.co",
            SB_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNvcnBnaXV4eWhmeGRucXd3bWx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDMwNzcsImV4cCI6MjA4NTg3OTA3N30.PMp5yZOISYrBG0UUcIGaXUPnmEAaWVKgQ3Y1W8Nea_E"
        };
        const sb = supabase.createClient(CONFIG.SB_URL, CONFIG.SB_KEY);

        // --- STATE ---
        let currentNik = localStorage.getItem('userNIK');
        let currentRecordId = null;
        let currentPump = "1";
        let nikChart;
        let masterStore = JSON.parse(localStorage.getItem('nik_master_store')) || {};

        const pumpFlowStd = [
            { label: 'P50', p: '50 ± 2', ne: 1900, i: 1.02, np: 1838, min: 524, max: 535, std: '502 ± 5' },
            { label: 'P137', p: '137 ± 5', ne: 1900, i: 1.02, np: 1838, min: 512, max: 523, std: '491 ± 5' },
            { label: 'P170', p: '170', ne: 1900, i: 1.02, np: 1838, min: 422, max: 453, std: '415 ± 15' },
            { label: 'P250', p: '250 ± 5', ne: 1900, i: 1.02, np: 1838, min: 284, max: 315, std: '284 ± 15' },
            { label: 'P300', p: '300 ± 2', ne: 1900, i: 1.02, np: 1838, min: 234, max: 245, std: '227 ± 5' }
        ];

        // --- PARTICLE ENGINE ---
        const canvas = document.getElementById('mecha-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        class MechaParticle {
            constructor() { this.reset(); }
            reset() {
                this.x = Math.random() * canvas.width; this.y = Math.random() * canvas.height;
                this.size = Math.random() * 2 + 1;
                this.speedY = (Math.random() - 0.5) * 0.5; this.speedX = (Math.random() - 0.5) * 0.5;
                this.opacity = Math.random() * 0.5 + 0.1;
            }
            update() { this.y += this.speedY; this.x += this.speedX; if (this.y < 0 || this.y > canvas.height || this.x < 0 || this.x > canvas.width) this.reset(); }
            draw() { ctx.fillStyle = `rgba(148, 163, 184, ${this.opacity})`; ctx.beginPath(); ctx.rect(this.x, this.y, this.size, this.size); ctx.fill(); }
        }
        function initParticles() { particles = []; for (let i = 0; i < 80; i++) particles.push(new MechaParticle()); }
        function animateParticles() { ctx.clearRect(0, 0, canvas.width, canvas.height); particles.forEach(p => { p.update(); p.draw(); }); requestAnimationFrame(animateParticles); }

        // --- APP LOGIC (ES8) ---
        const App = {
            async init() {
                resizeCanvas(); initParticles(); animateParticles();
                runAutoScale();
                window.addEventListener('resize', () => { resizeCanvas(); runAutoScale(); });

                initGeneralForms();
                await this.syncProfile();
                this.fetchHistory();

                const dateInp = document.getElementById('test_date');
                if(dateInp) dateInp.valueAsDate = new Date();
                
                document.getElementById('display-nik').innerText = currentNik || 'GUEST';
                document.getElementById('nik').value = currentNik || 'GUEST';

                setTimeout(() => {
                    const splash = document.getElementById('splash-screen');
                    splash.classList.add('fade-out');
                    setTimeout(() => splash.style.display = 'none', 500);
                }, 800);
            },

            async syncProfile() {
                if (!currentNik) return;
                try {
                    const { data } = await sb.from('users').select('full_name').eq('nik', currentNik).single();
                    const name = data ? data.full_name.toUpperCase() : "UNKNOWN";
                    document.getElementById('nama_pic').value = name;
                    localStorage.setItem('userName', name);
                } catch (err) { console.error(err); }
            },

            async fetchHistory() {
                const list = document.getElementById('history-list');
                const { data } = await sb.from('pump_performance_reports').select('*').order('created_at', { ascending: false }).limit(10);
                
                if (data && data.length > 0) {
                    list.innerHTML = data.map(rec => `
                        <div class="flex justify-between items-center p-4 bg-white rounded-xl border border-slate-200 shadow-sm hover:border-blue-400 hover:shadow-md transition-all cursor-pointer group" onclick="loadRecord('${rec.id}')">
                            <div>
                                <p class="text-xs font-bold text-slate-800 group-hover:text-blue-600 transition-colors">${rec.unit_model} - <span class="font-mono text-slate-500">${rec.serial_number}</span></p>
                                <p class="text-[10px] text-slate-400 font-mono mt-1"><i class="fas fa-calendar-alt mr-1"></i>${new Date(rec.test_date).toLocaleDateString()}</p>
                            </div>
                            <i class="fas fa-chevron-right text-slate-300 text-xs group-hover:text-blue-500 transform group-hover:translate-x-1 transition-all"></i>
                        </div>`).join('');
                } else {
                    list.innerHTML = `<div class="text-center p-6 text-slate-400 text-[10px] font-bold">NO HISTORY FOUND</div>`;
                }
            }
        };

        // --- ANIMATION ENGINE ---
        let isAnimating = false;
        let currentActiveTab = 'general';

        function switchTab(targetTab) {
            if (isAnimating || currentActiveTab === targetTab) return;
            isAnimating = true;
            
            const generalEl = document.getElementById('section-general');
            const pumpEl = document.getElementById('section-pump');
            const btnGen = document.getElementById('tab-gen');
            const btnPump = document.getElementById('tab-pump');

            btnGen.classList.toggle('active', targetTab === 'general');
            btnPump.classList.toggle('active', targetTab === 'pump');

            let outgoing, incoming;
            let outClass, inStartClass;

            if (targetTab === 'pump') {
                outgoing = generalEl; incoming = pumpEl;
                outClass = 'slide-out-left';
                inStartClass = 'slide-in-right-start';
            } else {
                outgoing = pumpEl; incoming = generalEl;
                outClass = 'slide-out-right';
                inStartClass = 'slide-in-left-start';
            }

            outgoing.classList.add(outClass);

            setTimeout(() => {
                outgoing.classList.add('mech-hidden');
                outgoing.classList.remove(outClass);

                incoming.classList.remove('mech-hidden');
                incoming.classList.add(inStartClass);
                void incoming.offsetWidth; // Force Reflow

                requestAnimationFrame(() => {
                    incoming.classList.remove(inStartClass);
                    
                    if(targetTab === 'pump') {
                        if(!nikChart) initChart();
                        renderPumpAnalysis();
                        // Delay chart resize to prevent layout thrashing
                        setTimeout(() => { if(nikChart) nikChart.resize(); }, 50);
                    }
                    
                    setTimeout(() => {
                        isAnimating = false;
                        currentActiveTab = targetTab;
                    }, 400); 
                });
            }, 300);
        }

        // --- VALIDATION HELPER ---
        function valColor(el, min, max) {
            const val = parseFloat(el.value);
            el.classList.remove('text-emerald-600', 'text-amber-500', 'text-red-500', 'font-black');
            if (isNaN(val)) return;

            el.classList.add('font-black');
            if (val >= min && val <= max) {
                el.classList.add('text-emerald-600'); // OK
            } else if (val < min) {
                el.classList.add('text-amber-500'); // Low
            } else {
                el.classList.add('text-red-500'); // High
            }
        }

        // --- UI HELPERS ---
        function runAutoScale() {
            const scaler = document.getElementById('scaler-context');
            const scaleRatio = window.innerWidth < 720 ? window.innerWidth / 720 : 1;
            scaler.style.transform = `scale(${scaleRatio})`;
            scaler.style.marginBottom = window.innerWidth < 720 ? `-${(1 - scaleRatio) * scaler.offsetHeight}px` : "0px";
        }

        function toggleHistory(event) {
            if(event) event.stopPropagation();
            const panel = document.getElementById('history-panel');
            panel.classList.toggle('minimized');
            if(!panel.classList.contains('minimized')) App.fetchHistory();
        }
        document.addEventListener('click', (e) => {
            const panel = document.getElementById('history-panel');
            const trigger = document.getElementById('history-trigger');
            if (!panel.contains(e.target) && !trigger.contains(e.target)) panel.classList.add('minimized');
        });

        // --- FORM INIT (WITH VALIDATION) ---
        function initGeneralForms() {
            // Components (No validation needed)
            const compBody = document.getElementById('comp-history-body');
            const comps = ["ENGINE", "PUMP 1-2", "PUMP 3-4", "PUMP 5-6", "PUMP 7-8"];
            compBody.innerHTML = comps.map(c => `
                <tr>
                    <td class="p-3 font-bold text-xs text-left pl-6 text-slate-700">${c}</td>
                    <td><input type="text" class="input-mecha !p-2 text-center data-comp text-xs font-mono"></td>
                    <td><input type="text" class="input-mecha !p-2 text-center data-comp text-xs font-mono"></td>
                    <td><input type="number" class="input-mecha !p-2 text-center data-comp text-xs font-mono"></td>
                    <td><input type="text" class="input-mecha !p-2 text-center data-comp text-xs"></td>
                </tr>`).join('');

            // Pump Grid (Main Relief: 300-320)
            const pumpGrid = document.getElementById('pump-relief-grid');
            pumpGrid.innerHTML = Array.from({length:8}, (_,i)=>`
                <div class="relative">
                    <label class="text-[10px] font-black text-slate-400 mb-1.5 block absolute top-2 left-3">P${i+1}</label>
                    <input type="number" class="input-mecha text-center font-mono text-lg font-bold text-blue-600 data-pump pt-6 pb-2" oninput="valColor(this, 300, 320)">
                </div>`).join('');

            // Engine (Parsed ranges)
            const engBody = document.getElementById('engine-speed-body');
            const engData = [{n: "Low Idle", s: "780-820"}, {n: "High Idle", s: "1850-1950"}, {n: "Auto Idle", s: "1350-1450"}, {n: "Relief Idle", s: "1770-1830"}];
            engBody.innerHTML = engData.map(e => {
                const [min, max] = e.s.split('-').map(Number);
                return `
                <tr>
                    <td class="p-3 font-bold text-slate-700 text-xs pl-6 text-left">${e.n}</td>
                    <td class="text-[10px] font-bold text-slate-400 font-mono">${e.s}</td>
                    <td class="p-1"><input type="number" class="input-mecha data-eng text-center font-bold text-blue-600" oninput="valColor(this, ${min}, ${max})"></td>
                    <td class="p-1"><input type="number" class="input-mecha data-eng text-center font-bold text-emerald-600" oninput="valColor(this, ${min}, ${max})"></td>
                </tr>`
            }).join('');

            // Cycle Time (Parsed ±)
            const cycBody = document.getElementById('cycle-time-body');
            const actions = [{n: "Boom Raise", s: "8.2±0.5"},{n: "Arm Roll-in", s: "7.0±0.5"},{n: "Arm Roll-out", s: "7.0±0.5"},{n: "Bucket Roll-in", s: "4.7±0.5"},{n: "Bucket Roll-out", s: "4.2±0.5"},{n: "Swing RH", s: "57±3"},{n: "Swing LH", s: "57±3"}];
            cycBody.innerHTML = actions.map(a => {
                const [base, tol] = a.s.split('±').map(Number);
                const min = (base - tol).toFixed(1);
                const max = (base + tol).toFixed(1);
                return `
                <tr>
                    <td class="text-xs text-left font-bold p-3 pl-6 text-slate-700">${a.n}</td>
                    <td class="text-[10px] font-mono text-slate-400 font-bold">${a.s}</td>
                    <td class="p-1"><input type="number" step="0.1" class="input-mecha text-center data-cyc font-bold text-blue-600" oninput="valColor(this, ${min}, ${max})"></td>
                    <td class="p-1"><input type="number" step="0.1" class="input-mecha text-center data-cyc font-bold text-emerald-600" oninput="valColor(this, ${min}, ${max})"></td>
                </tr>`
            }).join('');
        }

        // --- PUMP LOGIC ---
        function changePump(v) { 
            currentPump = v; 
            document.getElementById('active-p-num').innerText = v; 
            renderPumpAnalysis(); 
        }

        function renderPumpAnalysis() {
            const container = document.getElementById('pump-tables-container');
            const pumpData = masterStore[currentPump] || { valuesBefore: [], valuesAfter: [] };
            
            const buildTable = (title, type) => {
                const values = (type === 'after' ? pumpData.valuesAfter : pumpData.valuesBefore) || [];
                return `
                    <div class="glass-mecha mb-0">
                        <div class="bg-slate-50 p-3 border-b border-slate-200 flex justify-between items-center">
                            <h3 class="text-[10px] font-black text-slate-600 uppercase px-2 tracking-wider">${title}</h3>
                        </div>
                        <table class="w-full">
                            <thead><tr><th>Point</th><th>Press (Kg)</th><th class="text-blue-600">Flow Q</th><th>QC Calc</th><th>Std QC</th></tr></thead>
                            <tbody>
                                ${pumpFlowStd.map((item, i) => {
                                    const val = values[i] || '';
                                    const qc = val ? Math.round((item.np * val) / (item.i * item.ne)) : '-';
                                    let color = 'text-slate-400';
                                    if(qc !== '-') {
                                        const [base, tol] = item.std.split('±').map(Number);
                                        if (qc < base - tol) color = 'text-amber-500 font-black'; // Low
                                        else if (qc > base + tol) color = 'text-red-500 font-black'; // High
                                        else color = 'text-emerald-500 font-black'; // OK
                                    }
                                    return `<tr>
                                        <td class="font-bold text-slate-700">${item.label}</td>
                                        <td class="text-slate-400 font-mono text-[10px]">${item.p}</td>
                                        <td><input type="number" class="input-mecha !p-2 text-center w-24 font-mono text-blue-700 font-bold" data-type="${type}" data-idx="${i}" value="${val}" oninput="updatePumpValueRealtime(this)"></td>
                                        <td class="qc-output ${color} text-sm">${qc}</td>
                                        <td class="font-bold text-slate-400 text-[10px] font-mono">${item.std}</td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>`;
            };
            container.innerHTML = buildTable('1. BEFORE ADJUSTMENT', 'before') + buildTable('2. AFTER ADJUSTMENT', 'after');
            updateChart();
        }

        function updatePumpValueRealtime(el) {
            const type = el.dataset.type;
            const idx = parseInt(el.dataset.idx);
            if(!masterStore[currentPump]) masterStore[currentPump] = { valuesBefore: [], valuesAfter: [] };
            masterStore[currentPump][type === 'after' ? 'valuesAfter' : 'valuesBefore'][idx] = el.value;
            localStorage.setItem('nik_master_store', JSON.stringify(masterStore));
            
            renderPumpAnalysis();
            const newInput = document.querySelector(`input[data-type="${type}"][data-idx="${idx}"]`);
            if(newInput) {
                const val = newInput.value;
                newInput.focus();
                newInput.value = ''; newInput.value = val;
            }
        }

        function initChart() {
            const ctx = document.getElementById('nikChart').getContext('2d');
            if (nikChart) nikChart.destroy();
            nikChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: pumpFlowStd.map(d => d.label),
                    datasets: [
                        { label: 'Min', data: pumpFlowStd.map(i => parseInt(i.std.split('±')[0]) - parseInt(i.std.split('±')[1])), borderColor: '#cbd5e1', borderDash: [5,5], pointRadius: 0, borderWidth: 1 },
                        { label: 'Max', data: pumpFlowStd.map(i => parseInt(i.std.split('±')[0]) + parseInt(i.std.split('±')[1])), borderColor: '#cbd5e1', borderDash: [5,5], pointRadius: 0, borderWidth: 1 },
                        { label: 'Before', data: [], borderColor: '#94a3b8', tension: 0.3, pointRadius: 4, borderWidth: 2 },
                        { label: 'After', data: [], borderColor: '#2563eb', tension: 0.3, pointRadius: 5, borderWidth: 3, backgroundColor: 'rgba(37, 99, 235, 0.1)', fill: true }
                    ]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { labels: { font: { family: 'Rajdhani', size: 12 } } } },
                    scales: { y: { grid: { color: '#f1f5f9' } }, x: { grid: { display: false } } }
                }
            });
        }

        function updateChart() {
            if(!nikChart) return;
            const pumpData = masterStore[currentPump] || { valuesBefore: [], valuesAfter: [] };
            const calcQC = (v, i) => v ? Math.round((pumpFlowStd[i].np * v) / (pumpFlowStd[i].i * pumpFlowStd[i].ne)) : null;
            nikChart.data.datasets[2].data = (pumpData.valuesBefore || []).map(calcQC);
            nikChart.data.datasets[3].data = (pumpData.valuesAfter || []).map(calcQC);
            nikChart.update();
        }

        // --- CLOUD OPS ---
        async function saveToCloud() {
            const btn = document.querySelector('button[onclick="saveToCloud()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i>`;
            
            const recId = document.getElementById('current_record_id').value;
            const record = {
                test_date: document.getElementById('test_date').value,
                nik: document.getElementById('nik').value,
                unit_model: document.getElementById('unit_model').value.toUpperCase(),
                serial_number: document.getElementById('serial_num').value.toUpperCase(),
                hour_meter: document.getElementById('hour_meter').value,
                component_history: Array.from(document.querySelectorAll('.data-comp')).map(i => i.value),
                pump_relief_values: Array.from(document.querySelectorAll('.data-pump')).map(i => i.value),
                engine_speed_values: Array.from(document.querySelectorAll('.data-eng')).map(i => i.value),
                cycle_time_values: Array.from(document.querySelectorAll('.data-cyc')).map(i => i.value),
                all_pumps_data: masterStore
            };
            
            const { error } = recId ? await sb.from('pump_performance_reports').update(record).eq('id', recId) : await sb.from('pump_performance_reports').insert([record]);
            
            btn.innerHTML = originalText;
            if (error) alert("Sync Failed: " + error.message); 
            else { 
                alert("✅ Data Synced to Cloud!"); 
                prepareNewEntry(); 
                App.fetchHistory(); 
            }
        }

        async function loadRecord(id) {
            const { data } = await sb.from('pump_performance_reports').select('*').eq('id', id).single();
            if (data) {
                document.getElementById('current_record_id').value = data.id;
                document.getElementById('unit_model').value = data.unit_model;
                document.getElementById('serial_num').value = data.serial_number;
                document.getElementById('test_date').value = data.test_date;
                document.getElementById('hour_meter').value = data.hour_meter;
                masterStore = data.all_pumps_data || {};
                localStorage.setItem('nik_master_store', JSON.stringify(masterStore));
                
                // Helper to populate fields and trigger validation
                const populate = (sel, vals) => {
                    document.querySelectorAll(sel).forEach((el, i) => {
                        el.value = vals[i] || '';
                        el.dispatchEvent(new Event('input')); // Trigger validation color
                    });
                };

                populate('.data-comp', data.component_history || []);
                populate('.data-pump', data.pump_relief_values || []);
                populate('.data-eng', data.engine_speed_values || []);
                populate('.data-cyc', data.cycle_time_values || []);
                
                switchTab('general'); // Force switch to general to load inputs correctly first
                setTimeout(() => {
                    if(!document.getElementById('section-pump').classList.contains('mech-hidden')) renderPumpAnalysis();
                }, 500);

                document.getElementById('history-panel').classList.add('minimized');
                
                document.getElementById('sync-status').innerText = "EDIT MODE";
                document.getElementById('status-dot').className = "w-2.5 h-2.5 bg-amber-400 rounded-full animate-pulse";
            }
        }

        function prepareNewEntry() {
            document.getElementById('current_record_id').value = "";
            document.querySelectorAll('input:not([readonly])').forEach(i => {
                i.value = "";
                i.classList.remove('text-emerald-600', 'text-amber-500', 'text-red-500', 'font-black'); // Reset colors
            });
            document.getElementById('test_date').valueAsDate = new Date();
            masterStore = {};
            localStorage.removeItem('nik_master_store');
            if(!document.getElementById('section-pump').classList.contains('mech-hidden')) renderPumpAnalysis();
            document.getElementById('sync-status').innerText = "NEW ENTRY MODE";
            document.getElementById('status-dot').className = "w-2.5 h-2.5 bg-emerald-500 rounded-full animate-pulse";
        }

        window.onload = () => App.init();
    </script>
    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('../sw.js')
                .then(reg => console.log('Terminal Synced:', reg.scope))
                .catch(err => console.log('Sync Failed:', err));
        });
    }
    </script>

</body>
</html>
